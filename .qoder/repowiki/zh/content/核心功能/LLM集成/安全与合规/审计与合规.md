# 审计与合规

<cite>
**本文档引用的文件**   
- [session-manager.js](file://vibe_surf/chrome_extension/scripts/session-manager.js)
- [ui-manager.js](file://vibe_surf/chrome_extension/scripts/ui-manager.js)
- [activity.py](file://vibe_surf/backend/api/activity.py)
- [models.py](file://vibe_surf/backend/database/models.py)
- [logger.py](file://vibe_surf/langflow/logging/logger.py)
- [log_router.py](file://vibe_surf/langflow/api/log_router.py)
- [service.py](file://vibe_surf/telemetry/service.py)
- [database/manager.py](file://vibe_surf/backend/database/manager.py)
- [mcp_encryption.py](file://vibe_surf/langflow/services/auth/mcp_encryption.py)
- [encryption.py](file://vibe_surf/backend/utils/encryption.py)
</cite>

## 目录
1. [审计日志结构与内容](#审计日志结构与内容)
2. [日志存储与保留策略](#日志存储与保留策略)
3. [合规性检查机制](#合规性检查机制)
4. [合规报告生成](#合规报告生成)
5. [日志分析工具使用指南](#日志分析工具使用指南)
6. [审计日志查询示例](#审计日志查询示例)

## 审计日志结构与内容

VibeSurf的审计日志系统全面记录了LLM调用的详细信息，包括时间戳、用户标识和请求/响应数据。系统通过前端扩展和后端API协同工作，确保所有活动都被完整记录。

审计日志的核心结构包含以下关键字段：
- **agent_name**: 执行操作的代理名称
- **agent_status**: 代理当前状态（如"running"、"done"等）
- **agent_msg**: 代理执行过程中的详细消息
- **timestamp**: 活动发生的时间戳
- **session_id**: 关联的会话ID，用于追踪用户会话
- **task_id**: 关联的任务ID，用于追踪特定任务

日志记录发生在多个层面。前端Chrome扩展中的`SessionManager`类负责管理会话和活动日志，通过`activityLogs`数组存储日志条目，并在`pollActivity`方法中定期轮询新活动。当检测到新活动时，系统会通过`handleActivityUpdate`方法处理更新，并将活动数据持久化存储。

后端通过`activity.py`中的API路由提供日志检索功能，支持按会话ID、任务ID等多种方式查询日志。`get_session_activity_logs`端点允许客户端按消息索引获取特定日志条目，确保了日志的精确追溯能力。

**Section sources**
- [session-manager.js](file://vibe_surf/chrome_extension/scripts/session-manager.js#L252-L650)
- [ui-manager.js](file://vibe_surf/chrome_extension/scripts/ui-manager.js#L1612-L1650)
- [activity.py](file://vibe_surf/backend/api/activity.py#L1-L246)

## 日志存储与保留策略

VibeSurf采用分层的日志存储策略，结合内存缓冲和数据库持久化，确保日志数据的可靠性和可访问性。系统实现了符合不同法规要求的数据保留期限，满足GDPR、CCPA等数据隐私法规的要求。

日志存储架构包含三个主要组件：内存缓冲区、文件系统和数据库。`SizedLogBuffer`类实现了固定大小的内存缓冲区，通过双端队列(deque)存储日志条目，确保最新的日志始终可用。缓冲区大小可通过环境变量`LANGFLOW_LOG_RETRIEVER_BUFFER_SIZE`动态配置，支持灵活的存储策略。

文件系统日志通过`RotatingFileHandler`实现，支持基于大小的自动轮转。系统默认配置为10MB的最大文件大小，保留5个备份文件，确保日志文件不会无限增长。用户可以通过`log_rotation`参数自定义轮转策略，例如设置为"100 MB"以支持更大的存储需求。

数据库持久化通过SQLite实现，使用`DBMigrationManager`进行版本控制和模式迁移。系统通过`v001_initial_schema.sql`到`v007_add_schedule_table.sql`的迁移脚本管理数据库模式演进，确保数据结构的向后兼容性。`Task`模型存储任务执行的元数据，包括创建时间、开始时间、完成时间等，支持基于时间的查询和分析。

数据保留策略遵循最小化原则，敏感数据在使用后立即清除。系统通过`CleanupWorker`定期清理临时数据和过期记录，确保不会长期存储不必要的用户数据。对于需要长期保留的审计日志，系统实施了加密存储和访问控制，仅授权人员可以访问。

**Section sources**
- [logger.py](file://vibe_surf/langflow/logging/logger.py#L33-L346)
- [manager.py](file://vibe_surf/backend/database/manager.py#L27-L146)
- [temp_flow_cleanup.py](file://vibe_surf/langflow/services/task/temp_flow_cleanup.py#L74-L136)

## 合规性检查机制

VibeSurf内置了全面的合规性检查机制，确保LLM使用符合GDPR、CCPA等数据隐私法规的要求。系统通过数据加密、访问控制和审计追踪等多重措施，保护用户数据的隐私和安全。

数据加密是合规性检查的核心。系统使用Fernet对称加密算法保护敏感数据，包括API密钥和认证凭据。`encrypt_api_key`和`decrypt_api_key`函数实现了基于机器特定密钥的加密解密功能，确保即使数据库被泄露，敏感信息也无法被轻易解密。`mcp_encryption.py`中的`encrypt_auth_settings`和`decrypt_auth_settings`函数专门处理认证设置的加密，保护OAuth客户端密钥等敏感字段。

访问控制通过会话管理和权限验证实现。`SessionManager`类跟踪每个会话的状态，确保只有经过身份验证的用户才能访问其数据。系统通过`allowed_domains`配置限制代理可以访问的域名，防止未经授权的数据访问。`browser_use_agent.py`中的域验证逻辑确保代理只能在允许的域内操作，增强了安全性。

审计追踪机制确保所有操作都有迹可循。系统通过`ProductTelemetry`类捕获匿名化的使用数据，包括LLM调用、模型选择和执行时长。`ReportWriterTelemetryEvent`等事件类型记录了报告生成的详细信息，支持后续的合规性审查。所有日志条目都包含时间戳和用户标识，确保操作的可追溯性。

系统还实现了数据主体权利请求的支持。通过`get_task_info`和`get_session_tasks`等API端点，用户可以查询和获取其数据。`UploadedFile`模型记录了上传文件的详细信息，包括原始文件名、存储路径和上传时间，支持数据可移植性要求。

**Section sources**
- [mcp_encryption.py](file://vibe_surf/langflow/services/auth/mcp_encryption.py#L1-L120)
- [encryption.py](file://vibe_surf/backend/utils/encryption.py#L98-L172)
- [service.py](file://vibe_surf/telemetry/service.py#L1-L114)
- [models.py](file://vibe_surf/backend/database/models.py#L1-L289)

## 合规报告生成

VibeSurf提供了强大的合规报告生成功能，支持数据主体权利请求的处理和监管审查。系统通过结构化的报告模板和自动化生成流程，确保报告的完整性和一致性。

合规报告生成的核心是`ReportWriterAgent`，它使用预定义的提示模板生成符合要求的报告。`report_writer_prompt.py`中的提示包含详细的执行要求，包括必须分析文件、生成全面内容和完成格式化步骤。系统强制要求每个报告都必须包含格式化步骤，将内容转换为专业的HTML格式。

报告生成过程遵循严格的审计跟踪。当`vibe_surf_agent.py`调用报告生成器时，系统会记录详细的活动日志，包括生成成功或失败的状态、消息和报告路径。`log_agent_activity`函数确保每个关键步骤都被记录，支持后续的追溯和审查。

生成的报告存储在`reports/`目录下，文件名包含时间戳，确保唯一性。系统通过`write_file`工具将格式化的HTML内容写入目标文件，然后调用`task_done`标记任务完成。整个过程被`ReportWriterTelemetryEvent`事件捕获，包括版本、操作、模型、提供者、持续时间和成功状态等详细信息。

对于数据主体权利请求，系统提供了专门的查询接口。管理员可以通过`get_task_info`端点获取特定任务的详细信息，包括任务描述、状态、结果和错误消息。`Task`模型中的`task_metadata`字段存储了额外的上下文信息，支持更深入的分析和审查。

**Section sources**
- [report_writer_agent.py](file://vibe_surf/agents/report_writer_agent.py#L143-L315)
- [report_writer_prompt.py](file://vibe_surf/agents/prompts/report_writer_prompt.py#L61-L73)
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L935-L956)

## 日志分析工具使用指南

VibeSurf提供了多种日志分析工具，帮助管理员监控系统安全状况和排查问题。这些工具通过API端点和前端界面相结合，提供实时和历史日志的访问能力。

主要的日志分析工具包括：
- **实时日志流**: 通过`/logs-stream`端点提供HTTP/2服务器发送事件(SSE)，实现日志的实时推送。客户端可以建立长连接，接收实时的日志更新。
- **历史日志查询**: 通过`/logs`端点支持按时间范围查询历史日志，可以获取指定时间点之前或之后的日志条目。
- **会话活动监控**: 通过`/activity/sessions/{session_id}/activity`端点获取特定会话的活动日志，支持按消息索引精确查询。

使用这些工具的基本步骤如下：
1. 建立身份验证，获取访问令牌
2. 根据需要选择合适的API端点
3. 构造请求参数，如时间戳、行数限制等
4. 处理响应数据，进行分析和可视化

对于实时监控，建议使用`stream_logs`端点，它会持续发送日志更新，直到连接断开。对于历史分析，可以使用`logs`端点配合时间参数，获取特定时间段的日志数据。管理员还可以通过前端界面的活动日志面板，直观地查看会话活动。

系统还提供了日志缓冲区管理功能。`SizedLogBuffer`类的`get_after_timestamp`、`get_before_timestamp`和`get_last_n`方法支持灵活的日志检索。管理员可以根据需要调整缓冲区大小，平衡内存使用和日志保留需求。

**Section sources**
- [log_router.py](file://vibe_surf/langflow/api/log_router.py#L37-L103)
- [logger.py](file://vibe_surf/langflow/logging/logger.py#L85-L123)
- [session-manager.js](file://vibe_surf/chrome_extension/scripts/session-manager.js#L453-L545)

## 审计日志查询示例

以下是一些常见的审计日志查询示例，展示如何追溯特定的LLM调用事件：

### 查询特定会话的所有活动日志
```http
GET /activity/sessions/{session_id}/activity
```
此查询返回指定会话的所有活动日志，按时间顺序排列。响应包含`activity_logs`数组和`total_count`统计信息，便于全面了解会话活动。

### 查询特定索引的日志条目
```http
GET /activity/sessions/{session_id}/activity?message_index=5
```
此查询返回会话中索引为5的日志条目。系统会同时返回`total_available`字段，指示服务器端可用的日志总数，帮助客户端判断是否需要同步更多日志。

### 查询最近的任务
```http
GET /activity/tasks?limit=10
```
此查询返回最近的10个任务，按创建时间降序排列。每个任务包含任务ID、会话ID、状态、创建时间等详细信息，便于快速了解系统活动。

### 查询特定时间段的日志
```http
GET /logs?lines_after=100&timestamp=1700000000000
```
此查询返回指定时间戳之后的100条日志。时间戳以毫秒为单位，支持精确的时间范围查询。

### 实时监控日志流
```http
GET /logs-stream
Accept: text/event-stream
```
此查询建立一个SSE连接，实时接收新的日志条目。服务器会持续发送日志更新，直到客户端断开连接，适合用于实时监控和告警。

这些查询示例展示了VibeSurf审计系统的灵活性和强大功能，管理员可以根据具体需求组合使用这些API，实现全面的系统监控和安全审计。

**Section sources**
- [activity.py](file://vibe_surf/backend/api/activity.py#L154-L217)
- [log_router.py](file://vibe_surf/langflow/api/log_router.py#L73-L103)
- [session-manager.js](file://vibe_surf/chrome_extension/scripts/session-manager.js#L261-L283)
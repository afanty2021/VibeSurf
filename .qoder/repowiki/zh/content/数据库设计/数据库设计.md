# æ•°æ®åº“è®¾è®¡

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**   
- [models.py](file://vibe_surf/backend/database/models.py)
- [schemas.py](file://vibe_surf/backend/database/schemas.py)
- [queries.py](file://vibe_surf/backend/database/queries.py)
- [manager.py](file://vibe_surf/backend/database/manager.py)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql)
- [v002_add_agent_mode.sql](file://vibe_surf/backend/database/migrations/v002_add_agent_mode.sql)
- [v003_fix_task_status_case.sql](file://vibe_surf/backend/database/migrations/v003_fix_task_status_case.sql)
- [v004_add_voice_profiles.sql](file://vibe_surf/backend/database/migrations/v004_add_voice_profiles.sql)
- [v005_add_composio_integration.sql](file://vibe_surf/backend/database/migrations/v005_add_composio_integration.sql)
- [v006_add_credentials_table.sql](file://vibe_surf/backend/database/migrations/v006_add_credentials_table.sql)
- [v007_add_schedule_table.sql](file://vibe_surf/backend/database/migrations/v007_add_schedule_table.sql)
- [encryption.py](file://vibe_surf/backend/utils/encryption.py)
- [task.py](file://vibe_surf/backend/api/task.py)
- [config.py](file://vibe_surf/backend/api/config.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [æ•°æ®åº“æ¨¡å¼](#æ•°æ®åº“æ¨¡å¼)
3. [å®ä½“å…³ç³»å›¾](#å®ä½“å…³ç³»å›¾)
4. [è¡¨ç»“æ„è¯¦è§£](#è¡¨ç»“æ„è¯¦è§£)
5. [æ•°æ®åº“è¿ç§»ç®¡ç†](#æ•°æ®åº“è¿ç§»ç®¡ç†)
6. [æ•°æ®è®¿é—®æ¨¡å¼](#æ•°æ®è®¿é—®æ¨¡å¼)
7. [æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†](#æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†)
8. [æ•°æ®åº“å®‰å…¨è€ƒè™‘](#æ•°æ®åº“å®‰å…¨è€ƒè™‘)
9. [æ•°æ®åº“æ€§èƒ½ç›‘æ§](#æ•°æ®åº“æ€§èƒ½ç›‘æ§)
10. [é™„å½•](#é™„å½•)

## ç®€ä»‹

VibeSurfæ•°æ®åº“è®¾è®¡æ—¨åœ¨æ”¯æŒä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡æ‰§è¡Œç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿé›†æˆäº†LLMï¼ˆå¤§å‹è¯­è¨€æ¨¡å‹ï¼‰é…ç½®ç®¡ç†ã€ä»»åŠ¡æ‰§è¡Œè·Ÿè¸ªã€æ–‡ä»¶ä¸Šä¼ ç®¡ç†ã€MCPï¼ˆæ¨¡å‹æ§åˆ¶åè®®ï¼‰æœåŠ¡å™¨é…ç½®ã€è¯­éŸ³æ¨¡å‹é…ç½®ã€Composioå·¥å…·é›†æˆã€å‡­è¯ç®¡ç†å’Œå·¥ä½œæµè°ƒåº¦ç­‰åŠŸèƒ½ã€‚æ•°æ®åº“é‡‡ç”¨SQLiteä½œä¸ºé»˜è®¤å­˜å‚¨ï¼Œæ”¯æŒé€šè¿‡Alembicé£æ ¼çš„è¿ç§»è„šæœ¬è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œå¹¶ä½¿ç”¨æœºå™¨ç‰¹å®šçš„åŠ å¯†å¯†é’¥ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L1-L289)
- [manager.py](file://vibe_surf/backend/database/manager.py#L1-L319)

## æ•°æ®åº“æ¨¡å¼

VibeSurfæ•°æ®åº“æ¨¡å¼åŒ…å«å¤šä¸ªæ ¸å¿ƒå®ä½“ï¼Œè¿™äº›å®ä½“é€šè¿‡å¤–é”®å’Œå¼•ç”¨å…³ç³»ç›¸äº’å…³è”ã€‚ä¸»è¦å®ä½“åŒ…æ‹¬ï¼š

- **ä»»åŠ¡ (Task)**: è¡¨ç¤ºä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼ŒåŒ…å«ä»»åŠ¡æè¿°ã€çŠ¶æ€ã€LLMé…ç½®å¼•ç”¨ã€æ–‡ä»¶ä¸Šä¼ è·¯å¾„ã€å·¥ä½œåŒºç›®å½•ã€MCPæœåŠ¡å™¨é…ç½®ã€æ‰§è¡Œç»“æœã€é”™è¯¯ä¿¡æ¯ã€æŠ¥å‘Šè·¯å¾„ã€æ—¶é—´æˆ³å’Œå…ƒæ•°æ®ã€‚
- **LLMé…ç½® (LLMProfile)**: å­˜å‚¨LLMæä¾›å•†ã€æ¨¡å‹ã€åŸºç¡€URLã€åŠ å¯†çš„APIå¯†é’¥ã€LLMå‚æ•°ï¼ˆæ¸©åº¦ã€æœ€å¤§ä»¤ç‰Œæ•°ã€top_pã€é¢‘ç‡æƒ©ç½šã€ç§å­ï¼‰ã€æä¾›å•†ç‰¹å®šé…ç½®ã€æè¿°ã€æ˜¯å¦æ¿€æ´»ã€æ˜¯å¦é»˜è®¤ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€æœ€åä½¿ç”¨æ—¶é—´ã€‚
- **ä¸Šä¼ æ–‡ä»¶ (UploadedFile)**: è·Ÿè¸ªä¸Šä¼ çš„æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ–‡ä»¶IDã€åŸå§‹æ–‡ä»¶åã€å­˜å‚¨æ–‡ä»¶åã€æ–‡ä»¶è·¯å¾„ã€ä¼šè¯IDã€æ–‡ä»¶å¤§å°ã€MIMEç±»å‹ã€ä¸Šä¼ æ—¶é—´ã€ç›¸å¯¹è·¯å¾„ã€æ˜¯å¦å·²åˆ é™¤ã€åˆ é™¤æ—¶é—´ã€‚
- **MCPé…ç½® (McpProfile)**: ç®¡ç†MCPæœåŠ¡å™¨é…ç½®ï¼ŒåŒ…æ‹¬MCP IDã€æ˜¾ç¤ºåç§°ã€æœåŠ¡å™¨åç§°ã€æœåŠ¡å™¨å‚æ•°ï¼ˆJSONï¼‰ã€æè¿°ã€æ˜¯å¦æ¿€æ´»ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€æœ€åä½¿ç”¨æ—¶é—´ã€‚
- **è¯­éŸ³é…ç½® (VoiceProfile)**: ç®¡ç†è¯­éŸ³æ¨¡å‹é…ç½®ï¼ŒåŒ…æ‹¬é…ç½®IDã€é…ç½®åç§°ã€æ¨¡å‹ç±»å‹ï¼ˆASR/TTSï¼‰ã€æ¨¡å‹åç§°ã€åŠ å¯†çš„APIå¯†é’¥ã€å…ƒå‚æ•°ï¼ˆJSONï¼‰ã€æè¿°ã€æ˜¯å¦æ¿€æ´»ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€æœ€åä½¿ç”¨æ—¶é—´ã€‚
- **Composioå·¥å…·åŒ… (ComposioToolkit)**: ç®¡ç†Composioåº”ç”¨é›†æˆï¼ŒåŒ…æ‹¬IDã€åç§°ã€slugã€æè¿°ã€logo URLã€åº”ç”¨URLã€æ˜¯å¦å¯ç”¨ã€å·¥å…·ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€‚
- **å‡­è¯ (Credential)**: å­˜å‚¨åŠ å¯†çš„APIå¯†é’¥å’Œå…¶ä»–æ•æ„Ÿæ•°æ®ï¼ŒåŒ…æ‹¬IDã€é”®åã€åŠ å¯†å€¼ã€æè¿°ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€‚
- **è°ƒåº¦ (Schedule)**: ç®¡ç†å·¥ä½œæµè°ƒåº¦ï¼ŒåŒ…æ‹¬IDã€æµç¨‹IDã€cronè¡¨è¾¾å¼ã€æ˜¯å¦å¯ç”¨ã€æè¿°ã€ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´ã€ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ã€æ‰§è¡Œæ¬¡æ•°ã€åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L1-L289)

## å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
TASK {
string task_id PK
string session_id
text task_description
string status
string llm_profile_name FK
string upload_files_path
string workspace_dir
text mcp_server_config
text task_result
text error_message
string report_path
datetime created_at
datetime updated_at
datetime started_at
datetime completed_at
json task_metadata
string agent_mode
}
LLM_PROFILE {
string profile_id PK
string profile_name UK
string provider
string model
string base_url
text encrypted_api_key
json temperature
json max_tokens
json top_p
json frequency_penalty
json seed
json provider_config
text description
boolean is_active
boolean is_default
datetime created_at
datetime updated_at
datetime last_used_at
}
UPLOADED_FILE {
string file_id PK
string original_filename
string stored_filename
text file_path
string session_id
bigint file_size
string mime_type
datetime upload_time
text relative_path
boolean is_deleted
datetime deleted_at
}
MCP_PROFILE {
string mcp_id PK
string display_name UK
string mcp_server_name UK
json mcp_server_params
text description
boolean is_active
datetime created_at
datetime updated_at
datetime last_used_at
}
VOICE_PROFILE {
string profile_id PK
string voice_profile_name UK
string voice_model_type
string voice_model_name
text encrypted_api_key
json voice_meta_params
text description
boolean is_active
datetime created_at
datetime updated_at
datetime last_used_at
}
COMPOSIO_TOOLKIT {
string id PK
string name
string slug UK
text description
text logo
text app_url
boolean enabled
text tools
datetime created_at
datetime updated_at
}
CREDENTIAL {
string id PK
string key_name UK
text encrypted_value
text description
datetime created_at
datetime updated_at
}
SCHEDULE {
string id PK
string flow_id UK
string cron_expression
boolean is_enabled
text description
datetime last_execution_at
datetime next_execution_at
bigint execution_count
datetime created_at
datetime updated_at
}
TASK ||--o{ LLM_PROFILE : "llm_profile_name"
TASK ||--o{ UPLOADED_FILE : "session_id"
TASK ||--o{ MCP_PROFILE : "mcp_server_name"
TASK ||--o{ SCHEDULE : "flow_id"
VOICE_PROFILE ||--o{ TASK : "voice_profile"
COMPOSIO_TOOLKIT ||--o{ TASK : "toolkit"
CREDENTIAL ||--o{ LLM_PROFILE : "api_key"
CREDENTIAL ||--o{ VOICE_PROFILE : "api_key"
```

**Diagram sources **
- [models.py](file://vibe_surf/backend/database/models.py#L1-L289)

## è¡¨ç»“æ„è¯¦è§£

### ä»»åŠ¡è¡¨ (tasks)

ä»»åŠ¡è¡¨æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œç”¨äºè·Ÿè¸ªæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€å’Œç›¸å…³ä¿¡æ¯ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| task_id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | ä»»åŠ¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| session_id | VARCHAR(36) | å¦ | å¦ | å¦ | æ—  | å…³è”çš„ä¼šè¯ID |
| task_description | TEXT | å¦ | å¦ | å¦ | æ—  | ä»»åŠ¡çš„æè¿° |
| status | VARCHAR(9) | å¦ | å¦ | å¦ | 'pending' | ä»»åŠ¡çŠ¶æ€ï¼ˆpending, running, paused, completed, failed, stoppedï¼‰ |
| llm_profile_name | VARCHAR(100) | å¦ | å¦ | æ˜¯ | æ—  | å¼•ç”¨LLMé…ç½®çš„åç§° |
| upload_files_path | VARCHAR(500) | æ˜¯ | å¦ | å¦ | æ—  | ä¸Šä¼ æ–‡ä»¶çš„è·¯å¾„ |
| workspace_dir | VARCHAR(500) | æ˜¯ | å¦ | å¦ | æ—  | ä»»åŠ¡çš„å·¥ä½œåŒºç›®å½• |
| mcp_server_config | TEXT | æ˜¯ | å¦ | å¦ | æ—  | MCPæœåŠ¡å™¨é…ç½®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ |
| task_result | TEXT | æ˜¯ | å¦ | å¦ | æ—  | ä»»åŠ¡çš„æœ€ç»ˆç»“æœï¼ˆMarkdownæ ¼å¼ï¼‰ |
| error_message | TEXT | æ˜¯ | å¦ | å¦ | æ—  | é”™è¯¯ä¿¡æ¯ |
| report_path | VARCHAR(500) | æ˜¯ | å¦ | å¦ | æ—  | ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶è·¯å¾„ |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |
| started_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | å¼€å§‹æ—¶é—´ |
| completed_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | å®Œæˆæ—¶é—´ |
| task_metadata | JSON | æ˜¯ | å¦ | å¦ | æ—  | ä»»åŠ¡çš„å…ƒæ•°æ®ï¼ˆJSONï¼‰ |
| agent_mode | VARCHAR(50) | å¦ | å¦ | å¦ | 'thinking' | ä»£ç†æ‰§è¡Œæ¨¡å¼ï¼ˆ'thinking'æˆ–'direct'ï¼‰ |

**ç´¢å¼•ï¼š**
- `idx_tasks_status`: æŒ‰çŠ¶æ€ç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ã€‚
- `idx_tasks_session`: æŒ‰ä¼šè¯IDç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢ä¼šè¯ä¸­çš„ä»»åŠ¡ã€‚
- `idx_tasks_llm_profile`: æŒ‰LLMé…ç½®åç§°ç´¢å¼•ï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢ä½¿ç”¨ç‰¹å®šLLMé…ç½®çš„ä»»åŠ¡ã€‚
- `idx_tasks_created`: æŒ‰åˆ›å»ºæ—¶é—´ç´¢å¼•ï¼Œç”¨äºæŒ‰æ—¶é—´é¡ºåºæŸ¥è¯¢ä»»åŠ¡ã€‚

**çº¦æŸï¼š**
- `CHECK (status IN ('pending', 'running', 'paused', 'completed', 'failed', 'stopped'))`: ç¡®ä¿çŠ¶æ€å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L94-L136)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql#L30-L49)
- [v002_add_agent_mode.sql](file://vibe_surf/backend/database/migrations/v002_add_agent_mode.sql#L5)

### LLMé…ç½®è¡¨ (llm_profiles)

LLMé…ç½®è¡¨ç”¨äºç®¡ç†LLMæä¾›å•†ã€æ¨¡å‹ã€APIå¯†é’¥ç­‰é…ç½®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| profile_id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | é…ç½®çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| profile_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | ç”¨æˆ·å®šä¹‰çš„å”¯ä¸€åç§° |
| provider | VARCHAR(50) | å¦ | å¦ | å¦ | æ—  | LLMæä¾›å•†ï¼ˆå¦‚openai, anthropic, googleç­‰ï¼‰ |
| model | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | LLMæ¨¡å‹åç§° |
| base_url | VARCHAR(500) | æ˜¯ | å¦ | å¦ | æ—  | LLM APIçš„åŸºç¡€URL |
| encrypted_api_key | TEXT | æ˜¯ | å¦ | å¦ | æ—  | ä½¿ç”¨MACåœ°å€åŠ å¯†çš„APIå¯†é’¥ |
| temperature | JSON | æ˜¯ | å¦ | å¦ | æ—  | LLMå‚æ•° - æ¸©åº¦ |
| max_tokens | JSON | æ˜¯ | å¦ | å¦ | æ—  | LLMå‚æ•° - æœ€å¤§ä»¤ç‰Œæ•° |
| top_p | JSON | æ˜¯ | å¦ | å¦ | æ—  | LLMå‚æ•° - top_p |
| frequency_penalty | JSON | æ˜¯ | å¦ | å¦ | æ—  | LLMå‚æ•° - é¢‘ç‡æƒ©ç½š |
| seed | JSON | æ˜¯ | å¦ | å¦ | æ—  | LLMå‚æ•° - éšæœºç§å­ |
| provider_config | JSON | æ˜¯ | å¦ | å¦ | æ—  | ä¾›åº”å•†ç‰¹å®šé…ç½® |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| is_active | BOOLEAN | å¦ | å¦ | å¦ | 1 | æ˜¯å¦æ¿€æ´» |
| is_default | BOOLEAN | å¦ | å¦ | å¦ | 0 | æ˜¯å¦ä¸ºé»˜è®¤é…ç½® |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |
| last_used_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | æœ€åä½¿ç”¨æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_llm_profiles_name`: æŒ‰é…ç½®åç§°ç´¢å¼•ã€‚
- `idx_llm_profiles_active`: æŒ‰æ˜¯å¦æ¿€æ´»ç´¢å¼•ã€‚
- `idx_llm_profiles_default`: æŒ‰æ˜¯å¦é»˜è®¤ç´¢å¼•ã€‚
- `idx_llm_profiles_provider`: æŒ‰æä¾›å•†ç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L57-L92)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql#L9-L28)

### ä¸Šä¼ æ–‡ä»¶è¡¨ (uploaded_files)

ä¸Šä¼ æ–‡ä»¶è¡¨ç”¨äºè·Ÿè¸ªç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| file_id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| original_filename | VARCHAR(255) | å¦ | å¦ | å¦ | æ—  | åŸå§‹æ–‡ä»¶å |
| stored_filename | VARCHAR(255) | å¦ | å¦ | å¦ | æ—  | å­˜å‚¨çš„æ–‡ä»¶å |
| file_path | TEXT | å¦ | å¦ | å¦ | æ—  | æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ |
| session_id | VARCHAR(255) | æ˜¯ | å¦ | å¦ | æ—  | å…³è”çš„ä¼šè¯ID |
| file_size | BIGINT | å¦ | å¦ | å¦ | æ—  | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| mime_type | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | MIMEç±»å‹ |
| upload_time | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | ä¸Šä¼ æ—¶é—´ |
| relative_path | TEXT | å¦ | å¦ | å¦ | æ—  | ç›¸å¯¹äºå·¥ä½œåŒºç›®å½•çš„è·¯å¾„ |
| is_deleted | BOOLEAN | å¦ | å¦ | å¦ | 0 | æ˜¯å¦å·²åˆ é™¤ |
| deleted_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | åˆ é™¤æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_uploaded_files_session_time`: æŒ‰ä¼šè¯IDå’Œä¸Šä¼ æ—¶é—´ç´¢å¼•ã€‚
- `idx_uploaded_files_active`: æŒ‰æ˜¯å¦å·²åˆ é™¤å’Œä¸Šä¼ æ—¶é—´ç´¢å¼•ã€‚
- `idx_uploaded_files_filename`: æŒ‰åŸå§‹æ–‡ä»¶åç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L138-L155)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql#L51-L64)

### MCPé…ç½®è¡¨ (mcp_profiles)

MCPé…ç½®è¡¨ç”¨äºç®¡ç†MCPæœåŠ¡å™¨çš„é…ç½®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| mcp_id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | MCPé…ç½®çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| display_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | ç”¨æˆ·å‹å¥½çš„åç§° |
| mcp_server_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | æœåŠ¡å™¨æ ‡è¯†ç¬¦ï¼ˆå¦‚"filesystem", "markitdown"ï¼‰ |
| mcp_server_params | JSON | å¦ | å¦ | å¦ | æ—  | MCPæœåŠ¡å™¨å‚æ•°ï¼ˆJSONå¯¹è±¡ï¼‰ |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| is_active | BOOLEAN | å¦ | å¦ | å¦ | 1 | æ˜¯å¦æ¿€æ´» |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |
| last_used_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | æœ€åä½¿ç”¨æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_mcp_profiles_display_name`: æŒ‰æ˜¾ç¤ºåç§°ç´¢å¼•ã€‚
- `idx_mcp_profiles_server_name`: æŒ‰æœåŠ¡å™¨åç§°ç´¢å¼•ã€‚
- `idx_mcp_profiles_active`: æŒ‰æ˜¯å¦æ¿€æ´»ç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L168-L189)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql#L66-L77)

### è¯­éŸ³é…ç½®è¡¨ (voice_profiles)

è¯­éŸ³é…ç½®è¡¨ç”¨äºç®¡ç†è¯­éŸ³æ¨¡å‹çš„é…ç½®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| profile_id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | é…ç½®çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| voice_profile_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | ç”¨æˆ·å®šä¹‰çš„å”¯ä¸€åç§° |
| voice_model_type | VARCHAR(3) | å¦ | å¦ | å¦ | æ—  | è¯­éŸ³æ¨¡å‹ç±»å‹ï¼ˆ'asr'æˆ–'tts'ï¼‰ |
| voice_model_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | è¯­éŸ³æ¨¡å‹åç§° |
| encrypted_api_key | TEXT | æ˜¯ | å¦ | å¦ | æ—  | ä½¿ç”¨MACåœ°å€åŠ å¯†çš„APIå¯†é’¥ |
| voice_meta_params | JSON | æ˜¯ | å¦ | å¦ | æ—  | æ¨¡å‹ç‰¹å®šå‚æ•°ï¼ˆJSONï¼‰ |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| is_active | BOOLEAN | å¦ | å¦ | å¦ | 1 | æ˜¯å¦æ¿€æ´» |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |
| last_used_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | æœ€åä½¿ç”¨æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_voice_profiles_name`: æŒ‰é…ç½®åç§°ç´¢å¼•ã€‚
- `idx_voice_profiles_type`: æŒ‰æ¨¡å‹ç±»å‹ç´¢å¼•ã€‚
- `idx_voice_profiles_active`: æŒ‰æ˜¯å¦æ¿€æ´»ç´¢å¼•ã€‚

**çº¦æŸï¼š**
- `CHECK (voice_model_type IN ('asr', 'tts'))`: ç¡®ä¿æ¨¡å‹ç±»å‹åœ¨æœ‰æ•ˆèŒƒå›´å†…ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L29-L55)
- [v004_add_voice_profiles.sql](file://vibe_surf/backend/database/migrations/v004_add_voice_profiles.sql#L9-L22)

### Composioå·¥å…·åŒ…è¡¨ (composio_toolkits)

Composioå·¥å…·åŒ…è¡¨ç”¨äºç®¡ç†Composioåº”ç”¨é›†æˆã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | å·¥å…·åŒ…çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | å·¥å…·åŒ…åç§° |
| slug | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆå¦‚"google", "github"ï¼‰ |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| logo | TEXT | æ˜¯ | å¦ | å¦ | æ—  | Logoçš„URL |
| app_url | TEXT | æ˜¯ | å¦ | å¦ | æ—  | åº”ç”¨URL |
| enabled | BOOLEAN | å¦ | å¦ | å¦ | 0 | æ˜¯å¦å¯ç”¨ |
| tools | TEXT | æ˜¯ | å¦ | å¦ | æ—  | å·¥å…·åç§°åˆ°å¯ç”¨çŠ¶æ€çš„æ˜ å°„ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_composio_toolkits_name`: æŒ‰åç§°ç´¢å¼•ã€‚
- `idx_composio_toolkits_slug`: æŒ‰slugç´¢å¼•ã€‚
- `idx_composio_toolkits_enabled`: æŒ‰æ˜¯å¦å¯ç”¨ç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L192-L215)
- [v005_add_composio_integration.sql](file://vibe_surf/backend/database/migrations/v005_add_composio_integration.sql#L9-L20)

### å‡­è¯è¡¨ (credentials)

å‡­è¯è¡¨ç”¨äºå­˜å‚¨åŠ å¯†çš„APIå¯†é’¥å’Œå…¶ä»–æ•æ„Ÿæ•°æ®ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | å‡­è¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| key_name | VARCHAR(100) | å¦ | å¦ | å¦ | æ—  | é”®åï¼ˆå¦‚"COMPOSIO_API_KEY"ï¼‰ |
| encrypted_value | TEXT | æ˜¯ | å¦ | å¦ | æ—  | ä½¿ç”¨MACåœ°å€åŠ å¯†çš„å€¼ |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_credentials_key_name`: æŒ‰é”®åç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L217-L234)
- [v006_add_credentials_table.sql](file://vibe_surf/backend/database/migrations/v006_add_credentials_table.sql#L8-L15)

### è°ƒåº¦è¡¨ (schedules)

è°ƒåº¦è¡¨ç”¨äºç®¡ç†å·¥ä½œæµçš„è°ƒåº¦ã€‚

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦ä¸ºç©º | ä¸»é”® | å¤–é”® | é»˜è®¤å€¼ | æè¿° |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| id | VARCHAR(36) | å¦ | æ˜¯ | å¦ | UUID7å­—ç¬¦ä¸² | è°ƒåº¦çš„å”¯ä¸€æ ‡è¯†ç¬¦ |
| flow_id | VARCHAR(36) | å¦ | å¦ | å¦ | æ—  | å…³è”çš„æµç¨‹IDï¼ˆå”¯ä¸€ï¼‰ |
| cron_expression | VARCHAR(100) | æ˜¯ | å¦ | å¦ | æ—  | æ ‡å‡†cronæ ¼å¼ |
| is_enabled | BOOLEAN | å¦ | å¦ | å¦ | 1 | æ˜¯å¦å¯ç”¨ |
| description | TEXT | æ˜¯ | å¦ | å¦ | æ—  | æè¿° |
| last_execution_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´ |
| next_execution_at | DATETIME | æ˜¯ | å¦ | å¦ | æ—  | ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ |
| execution_count | BIGINT | å¦ | å¦ | å¦ | 0 | æ‰§è¡Œæ¬¡æ•° |
| created_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| updated_at | DATETIME | å¦ | å¦ | å¦ | CURRENT_TIMESTAMP | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•ï¼š**
- `idx_schedules_flow_id`: æŒ‰æµç¨‹IDç´¢å¼•ã€‚
- `idx_schedules_enabled`: æŒ‰æ˜¯å¦å¯ç”¨ç´¢å¼•ã€‚
- `idx_schedules_next_execution`: æŒ‰ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ç´¢å¼•ã€‚
- `idx_schedules_cron`: æŒ‰cronè¡¨è¾¾å¼ç´¢å¼•ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L258-L283)
- [v007_add_schedule_table.sql](file://vibe_surf/backend/database/migrations/v007_add_schedule_table.sql#L4-L15)

## æ•°æ®åº“è¿ç§»ç®¡ç†

VibeSurfä½¿ç”¨ä¸€ä¸ªç®€åŒ–çš„è¿ç§»ç®¡ç†ç³»ç»Ÿæ¥ç®¡ç†æ•°æ®åº“æ¨¡å¼çš„æ¼”è¿›ã€‚è¯¥ç³»ç»ŸåŸºäºSQLiteçš„`PRAGMA user_version`æ¥è·Ÿè¸ªæ•°æ®åº“ç‰ˆæœ¬ï¼Œå¹¶é€šè¿‡æ‰§è¡ŒSQLè¿ç§»è„šæœ¬æ¥åº”ç”¨æ›´æ”¹ã€‚

### è¿ç§»è„šæœ¬ç¼–å†™è§„èŒƒ

è¿ç§»è„šæœ¬ä½äº`vibe_surf/backend/database/migrations/`ç›®å½•ä¸‹ï¼Œéµå¾ªä»¥ä¸‹å‘½åå’Œæ ¼å¼è§„èŒƒï¼š

- **æ–‡ä»¶å‘½å**: `v{ç‰ˆæœ¬å·}_{æè¿°}.sql`ï¼Œä¾‹å¦‚`v001_initial_schema.sql`ã€‚
- **ç‰ˆæœ¬å·**: ä¸‰ä½æ•°å­—ï¼Œä»`001`å¼€å§‹é€’å¢ã€‚
- **æè¿°**: ç®€çŸ­æè¿°è¿ç§»çš„ç›®çš„ã€‚
- **å†…å®¹ç»“æ„**:
  1. æ³¨é‡Šå¤´ï¼šåŒ…å«è¿ç§»åç§°ã€æè¿°å’Œç‰ˆæœ¬ã€‚
  2. `PRAGMA foreign_keys = ON;`: å¯ç”¨å¤–é”®çº¦æŸã€‚
  3. DDLè¯­å¥ï¼š`CREATE TABLE`, `ALTER TABLE`, `DROP TABLE`ç­‰ã€‚
  4. ç´¢å¼•åˆ›å»ºï¼š`CREATE INDEX`ã€‚
  5. è§¦å‘å™¨åˆ›å»ºï¼š`CREATE TRIGGER`ï¼ˆç”¨äºè‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³ï¼‰ã€‚

### è¿ç§»ç®¡ç†å™¨

`DBMigrationManager`ç±»è´Ÿè´£ç®¡ç†è¿ç§»è¿‡ç¨‹ï¼š

- **`get_db_version()`**: ä»`PRAGMA user_version`è¯»å–å½“å‰æ•°æ®åº“ç‰ˆæœ¬ã€‚
- **`set_db_version(version)`**: è®¾ç½®æ•°æ®åº“ç‰ˆæœ¬ã€‚
- **`get_migration_files()`**: æ‰«æè¿ç§»ç›®å½•ï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºè¿”å›è¿ç§»æ–‡ä»¶åˆ—è¡¨ã€‚
- **`apply_migrations(target_version)`**: åº”ç”¨ä»å½“å‰ç‰ˆæœ¬åˆ°ç›®æ ‡ç‰ˆæœ¬çš„æ‰€æœ‰è¿ç§»è„šæœ¬ã€‚

è¿ç§»è¿‡ç¨‹æ˜¯åŸå­çš„ï¼Œå¦‚æœæŸä¸ªè¿ç§»å¤±è´¥ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šå›æ»šå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚

**Section sources**
- [manager.py](file://vibe_surf/backend/database/manager.py#L27-L145)
- [v001_initial_schema.sql](file://vibe_surf/backend/database/migrations/v001_initial_schema.sql)
- [v002_add_agent_mode.sql](file://vibe_surf/backend/database/migrations/v002_add_agent_mode.sql)
- [v003_fix_task_status_case.sql](file://vibe_surf/backend/database/migrations/v003_fix_task_status_case.sql)
- [v004_add_voice_profiles.sql](file://vibe_surf/backend/database/migrations/v004_add_voice_profiles.sql)
- [v005_add_composio_integration.sql](file://vibe_surf/backend/database/migrations/v005_add_composio_integration.sql)
- [v006_add_credentials_table.sql](file://vibe_surf/backend/database/migrations/v006_add_credentials_table.sql)
- [v007_add_schedule_table.sql](file://vibe_surf/backend/database/migrations/v007_add_schedule_table.sql)

## æ•°æ®è®¿é—®æ¨¡å¼

VibeSurfé€šè¿‡`queries.py`æ–‡ä»¶ä¸­çš„æŸ¥è¯¢ç±»æä¾›äº†ä¸€å¥—å®Œæ•´çš„æ•°æ®è®¿é—®æ¨¡å¼ã€‚

### å¸¸ç”¨æŸ¥è¯¢

#### LLMé…ç½®æŸ¥è¯¢ (LLMProfileQueries)
- `create_profile()`: åˆ›å»ºæ–°çš„LLMé…ç½®ï¼Œè‡ªåŠ¨åŠ å¯†APIå¯†é’¥ã€‚
- `get_profile()`: é€šè¿‡åç§°è·å–LLMé…ç½®ã€‚
- `get_profile_with_decrypted_key()`: è·å–LLMé…ç½®å¹¶è§£å¯†APIå¯†é’¥ã€‚
- `list_profiles()`: åˆ—å‡ºæ‰€æœ‰ï¼ˆæˆ–ä»…æ¿€æ´»çš„ï¼‰LLMé…ç½®ã€‚
- `update_profile()`: æ›´æ–°LLMé…ç½®ï¼Œå¤„ç†APIå¯†é’¥çš„åŠ å¯†ã€‚
- `delete_profile()`: åˆ é™¤LLMé…ç½®ã€‚
- `get_default_profile()`: è·å–é»˜è®¤çš„LLMé…ç½®ã€‚
- `set_default_profile()`: è®¾ç½®é»˜è®¤çš„LLMé…ç½®ã€‚
- `update_last_used()`: æ›´æ–°é…ç½®çš„æœ€åä½¿ç”¨æ—¶é—´ã€‚

#### ä»»åŠ¡æŸ¥è¯¢ (TaskQueries)
- `save_task()`: åˆ›å»ºæˆ–æ›´æ–°ä»»åŠ¡è®°å½•ã€‚
- `get_task()`: é€šè¿‡IDè·å–ä»»åŠ¡ã€‚
- `get_tasks_by_session()`: è·å–ä¼šè¯ä¸­çš„æ‰€æœ‰ä»»åŠ¡ã€‚
- `get_recent_tasks()`: è·å–æœ€è¿‘çš„ä»»åŠ¡ã€‚
- `get_all_sessions()`: è·å–æ‰€æœ‰å”¯ä¸€ä¼šè¯åŠå…¶å…ƒæ•°æ®ã€‚
- `update_task_status()`: æ›´æ–°ä»»åŠ¡çŠ¶æ€ã€‚
- `delete_task()`: åˆ é™¤ä»»åŠ¡ã€‚
- `get_running_tasks()`: è·å–æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚
- `get_active_task()`: è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼ˆå•ä»»åŠ¡æ¨¡å‹ï¼‰ã€‚
- `get_tasks_by_llm_profile()`: è·å–ä½¿ç”¨ç‰¹å®šLLMé…ç½®çš„ä»»åŠ¡ã€‚
- `update_task_completion()`: æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€å’Œç»“æœã€‚
- `get_task_counts_by_status()`: æŒ‰çŠ¶æ€è·å–ä»»åŠ¡è®¡æ•°ã€‚

#### MCPé…ç½®æŸ¥è¯¢ (McpProfileQueries)
- `create_profile()`: åˆ›å»ºæ–°çš„MCPé…ç½®ã€‚
- `get_profile()`: é€šè¿‡IDè·å–MCPé…ç½®ã€‚
- `get_profile_by_display_name()`: é€šè¿‡æ˜¾ç¤ºåç§°è·å–MCPé…ç½®ã€‚
- `list_profiles()`: åˆ—å‡ºæ‰€æœ‰ï¼ˆæˆ–ä»…æ¿€æ´»çš„ï¼‰MCPé…ç½®ã€‚
- `get_active_profiles()`: è·å–æ‰€æœ‰æ¿€æ´»çš„MCPé…ç½®ã€‚
- `update_profile()`: æ›´æ–°MCPé…ç½®ã€‚
- `delete_profile()`: åˆ é™¤MCPé…ç½®ã€‚
- `update_last_used()`: æ›´æ–°é…ç½®çš„æœ€åä½¿ç”¨æ—¶é—´ã€‚

#### ä¸Šä¼ æ–‡ä»¶æŸ¥è¯¢ (UploadedFileQueries)
- `create_file_record()`: åˆ›å»ºä¸Šä¼ æ–‡ä»¶è®°å½•ã€‚
- `get_file()`: é€šè¿‡IDè·å–ä¸Šä¼ æ–‡ä»¶ã€‚

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

- **ç´¢å¼•**: ä¸ºé¢‘ç¹æŸ¥è¯¢çš„å­—æ®µï¼ˆå¦‚`status`, `session_id`, `llm_profile_name`, `created_at`ï¼‰åˆ›å»ºäº†ç´¢å¼•ã€‚
- **æ‰¹é‡æ“ä½œ**: æŸ¥è¯¢æ–¹æ³•æ”¯æŒ`limit`å’Œ`offset`å‚æ•°ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®ã€‚
- **è¿æ¥ç®¡ç†**: ä½¿ç”¨`DatabaseManager`ç®¡ç†æ•°æ®åº“è¿æ¥æ± ï¼Œä¼˜åŒ–è¿æ¥å¤ç”¨ã€‚
- **å¼‚æ­¥æ“ä½œ**: æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

**Section sources**
- [queries.py](file://vibe_surf/backend/database/queries.py#L21-L800)
- [task.py](file://vibe_surf/backend/api/task.py#L43-L379)
- [config.py](file://vibe_surf/backend/api/config.py#L78-L762)

## æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

### æ•°æ®ä¿ç•™ç­–ç•¥

- **ä»»åŠ¡æ•°æ®**: ä»»åŠ¡è®°å½•åœ¨å®Œæˆåé•¿æœŸä¿ç•™ï¼Œé™¤éç”¨æˆ·æ‰‹åŠ¨åˆ é™¤ã€‚
- **ä¸Šä¼ æ–‡ä»¶**: æ–‡ä»¶åœ¨ä»»åŠ¡å®Œæˆåä¿ç•™åœ¨å·¥ä½œåŒºç›®å½•ä¸­ï¼Œç›´åˆ°ç”¨æˆ·æ‰‹åŠ¨æ¸…ç†æˆ–ç³»ç»Ÿæ‰§è¡Œå½’æ¡£ã€‚
- **æ—¥å¿—æ•°æ®**: ç³»ç»Ÿæ—¥å¿—ï¼ˆå¦‚`telemetry`ï¼‰æ ¹æ®é…ç½®çš„ä¿ç•™ç­–ç•¥è¿›è¡Œè½®è½¬å’Œæ¸…ç†ã€‚

### å½’æ¡£å’Œæ¸…ç†æœºåˆ¶

- **æ‰‹åŠ¨æ¸…ç†**: ç”¨æˆ·å¯ä»¥é€šè¿‡APIæˆ–å‰ç«¯ç•Œé¢åˆ é™¤ä»»åŠ¡ã€æ–‡ä»¶å’Œé…ç½®ã€‚
- **è‡ªåŠ¨å½’æ¡£**: ç³»ç»Ÿå¯ä»¥é…ç½®ä¸ºå®šæœŸå°†æ—§çš„ä»»åŠ¡æ•°æ®å½’æ¡£åˆ°å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚äº‘å­˜å‚¨ï¼‰ã€‚
- **è½¯åˆ é™¤**: `uploaded_files`è¡¨ä¸­çš„`is_deleted`å­—æ®µæ”¯æŒè½¯åˆ é™¤ï¼Œæ–‡ä»¶åœ¨æ ‡è®°ä¸ºåˆ é™¤åä»å¯æ¢å¤ã€‚

**Section sources**
- [models.py](file://vibe_surf/backend/database/models.py#L151)
- [queries.py](file://vibe_surf/backend/database/queries.py#L650-L657)

## æ•°æ®åº“å®‰å…¨è€ƒè™‘

### åŠ å¯†

æ•æ„Ÿæ•°æ®ï¼ˆå¦‚APIå¯†é’¥ï¼‰ä½¿ç”¨æœºå™¨ç‰¹å®šçš„å¯†é’¥è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†å¯†é’¥åŸºäºæœºå™¨çš„MACåœ°å€æˆ–æœ¬åœ°ç”¨æˆ·IDæ´¾ç”Ÿã€‚

- **`derive_key(machine_id, salt)`**: ä½¿ç”¨PBKDF2HMACç®—æ³•ä»æœºå™¨IDæ´¾ç”ŸåŠ å¯†å¯†é’¥ã€‚
- **`get_encryption_key()`**: è·å–å½“å‰æœºå™¨çš„åŠ å¯†å¯†é’¥ã€‚
- **`encrypt_api_key(api_key)`**: ä½¿ç”¨FernetåŠ å¯†APIå¯†é’¥ã€‚
- **`decrypt_api_key(encrypted_api_key)`**: è§£å¯†APIå¯†é’¥ã€‚

åŠ å¯†åçš„æ•°æ®ä»¥Base64ç¼–ç å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

### å¤‡ä»½å’Œæ¢å¤æµç¨‹

- **å¤‡ä»½**: ç”±äºä½¿ç”¨SQLiteï¼Œå¤‡ä»½æ•´ä¸ªæ•°æ®åº“æ–‡ä»¶ï¼ˆ`vibe_surf.db`ï¼‰å³å¯ã€‚å»ºè®®å®šæœŸå°†æ­¤æ–‡ä»¶å¤åˆ¶åˆ°å®‰å…¨ä½ç½®ã€‚
- **æ¢å¤**: å°†å¤‡ä»½çš„æ•°æ®åº“æ–‡ä»¶å¤åˆ¶å›å·¥ä½œåŒºç›®å½•ï¼Œæ›¿æ¢ç°æœ‰æ–‡ä»¶ã€‚

**Section sources**
- [encryption.py](file://vibe_surf/backend/utils/encryption.py#L1-L172)
- [manager.py](file://vibe_surf/backend/database/manager.py#L157-L161)

## æ•°æ®åº“æ€§èƒ½ç›‘æ§

### å…³é”®æŒ‡æ ‡

- **æ•°æ®åº“ç‰ˆæœ¬**: é€šè¿‡`get_db_version()`ç›‘æ§æ•°æ®åº“æ¨¡å¼ç‰ˆæœ¬ã€‚
- **ä»»åŠ¡çŠ¶æ€è®¡æ•°**: é€šè¿‡`get_task_counts_by_status()`ç›‘æ§ä¸åŒçŠ¶æ€çš„ä»»åŠ¡æ•°é‡ã€‚
- **è¿æ¥æ± çŠ¶æ€**: ç›‘æ§æ•°æ®åº“è¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µï¼ˆç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨PostgreSQLæ—¶ï¼‰ã€‚
- **æŸ¥è¯¢æ€§èƒ½**: é€šè¿‡æ—¥å¿—è®°å½•æ…¢æŸ¥è¯¢ã€‚

### å‘Šè­¦è®¾ç½®

- **æ¨¡å¼ä¸ä¸€è‡´**: å¦‚æœæ•°æ®åº“ç‰ˆæœ¬ä¸é¢„æœŸç‰ˆæœ¬ä¸åŒ¹é…ï¼Œåº”å‘å‡ºå‘Šè­¦ã€‚
- **ä»»åŠ¡ç§¯å‹**: å¦‚æœ`running`æˆ–`pending`çŠ¶æ€çš„ä»»åŠ¡æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œåº”å‘å‡ºå‘Šè­¦ã€‚
- **è¿æ¥å¤±è´¥**: å¦‚æœæ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œåº”å‘å‡ºä¸¥é‡å‘Šè­¦ã€‚

**Section sources**
- [manager.py](file://vibe_surf/backend/database/manager.py#L258-L268)
- [queries.py](file://vibe_surf/backend/database/queries.py#L736-L752)

## é™„å½•

### æ•°æ®åº“åˆå§‹åŒ–

æ•°æ®åº“é€šè¿‡`init_database()`å‡½æ•°åˆå§‹åŒ–ã€‚è¯¥å‡½æ•°ä¼šæ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬ï¼Œå¦‚æœä¸º0ï¼Œåˆ™åº”ç”¨æ‰€æœ‰è¿ç§»è„šæœ¬ï¼›å¦åˆ™ï¼Œä½¿ç”¨ç›´æ¥è¡¨åˆ›å»ºã€‚

```python
async def init_database():
    """Initialize database with tables"""
    from .. import shared_state

    logger.info("ğŸ—„ï¸ Initializing VibeSurf database...")

    try:
        if not shared_state.db_manager:
            raise RuntimeError("Database manager not initialized. Call initialize_vibesurf_components() first.")

        await shared_state.db_manager.create_tables()
        logger.info("âœ… Database tables created successfully")
        logger.info("âœ… VibeSurf database ready for single-task execution")

    except Exception as e:
        logger.error(f"âŒ Database initialization failed: {e}")
        raise
```

**Section sources**
- [manager.py](file://vibe_surf/backend/database/manager.py#L287-L304)
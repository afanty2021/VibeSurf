# 代理测试与调试

<cite>
**本文档引用的文件**   
- [test_agents.py](file://tests/test_agents.py)
- [test_backend_api.py](file://tests/test_backend_api.py)
- [test_browser.py](file://tests/test_browser.py)
- [test_tools.py](file://tests/test_tools.py)
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py)
- [views.py](file://vibe_surf/agents/views.py)
- [main.py](file://vibe_surf/backend/main.py)
- [tools.py](file://vibe_surf/tools/views.py)
</cite>

## 目录
1. [介绍](#介绍)
2. [单元测试与集成测试](#单元测试与集成测试)
3. [调试技巧](#调试技巧)
4. [代理状态监控](#代理状态监控)
5. [常见问题诊断](#常见问题诊断)
6. [性能监控与错误处理](#性能监控与错误处理)

## 介绍
VibeSurf代理系统是一个复杂的自动化框架，集成了LLM（大语言模型）、浏览器操作和多种工具调用功能。为了确保系统的稳定性和可靠性，需要建立全面的测试和调试机制。本指南将详细介绍如何为自定义代理编写测试，如何调试代理执行流程，以及如何监控和诊断系统中的各种问题。

**Section sources**
- [test_agents.py](file://tests/test_agents.py#L1-L391)
- [test_backend_api.py](file://tests/test_backend_api.py#L1-L777)

## 单元测试与集成测试

### 模拟LLM响应
在测试中，可以通过配置不同的LLM客户端来模拟LLM响应。例如，在`test_agents.py`中，可以切换不同的LLM模型和端点：

```python
llm = ChatOpenAICompatible(model='deepseek-reasoner',
                          base_url=os.getenv("DEEPSEEK_ENDPOINT"),
                          api_key=os.getenv("DEEPSEEK_API_KEY"))
```

通过更改模型名称和端点，可以测试代理在不同LLM配置下的行为。

### 浏览器操作测试
浏览器操作的测试主要通过`test_browser.py`文件中的测试函数来实现。这些测试验证了多代理隔离、代理清理和并发状态捕获等功能：

```python
async def test_browser_state_capture(manager: BrowserManager):
    """验证两个代理可以同时捕获其状态并保存截图。"""
    # ... 测试代码
```

这些测试确保了浏览器操作的正确性和并发性。

### 工具调用测试
工具调用的测试在`test_tools.py`中实现，涵盖了MCP（Model Context Protocol）服务器、文件系统、金融数据检索和Composio集成等：

```python
async def test_tools_with_mcp():
    """测试带有MCP的工具。"""
    # ... 测试代码
```

这些测试验证了各种工具的正确集成和功能。

**Section sources**
- [test_agents.py](file://tests/test_agents.py#L1-L391)
- [test_browser.py](file://tests/test_browser.py#L1-L416)
- [test_tools.py](file://tests/test_tools.py#L1-L251)

## 调试技巧

### 日志分析
VibeSurf系统使用详细的日志记录来跟踪代理的执行过程。日志信息包括代理状态、消息内容、令牌使用情况等：

```python
async def log_agent_activity(state: VibeSurfState, agent_name: str, agent_status: str, agent_msg: str) -> None:
    """将代理活动记录到活动日志中"""
    # ... 日志记录代码
```

通过分析这些日志，可以深入了解代理的决策过程和执行状态。

### 断点调试
在开发和调试过程中，可以使用`pdb`（Python调试器）来设置断点，逐步执行代码并检查变量状态：

```python
import pdb
pdb.set_trace()
```

这种方法对于理解复杂的执行流程和定位问题非常有用。

### 状态追踪
代理的状态通过`VibeSurfState`类进行管理，该类包含了任务信息、浏览器任务、结果和控制状态等：

```python
@dataclass
class VibeSurfState:
    """VibeSurfAgent工作流的LangGraph状态"""
    # ... 状态定义
```

通过检查和修改这个状态对象，可以更好地理解和控制代理的执行过程。

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L1-L1840)
- [views.py](file://vibe_surf/agents/views.py#L1-L124)

## 代理状态监控

### API端点
VibeSurf后端提供了多个API端点来监控代理状态和执行进度。这些端点在`main.py`中定义：

```python
@app.get("/api/status")
async def get_system_status():
    """获取当前系统状态"""
    # ... 状态获取代码
```

通过调用这些API端点，可以实时监控代理的运行状态。

### 活动日志
活动日志是监控代理执行的重要工具。日志信息包括代理名称、状态、消息内容和时间戳：

```python
activity_entry = {
    "agent_name": agent_name,
    "agent_status": agent_status,
    "agent_msg": processed_agent_msg,
    "timestamp": datetime.now().isoformat(),
    "total_tokens": token_summary.total_tokens,
    "total_cost": token_summary.total_cost
}
```

这些日志可以帮助开发者和用户了解代理的执行过程和结果。

**Section sources**
- [main.py](file://vibe_surf/backend/main.py#L1-L794)
- [views.py](file://vibe_surf/agents/views.py#L1-L124)

## 常见问题诊断

### 超时问题
超时问题通常与LLM调用或网络请求有关。可以通过增加超时时间或优化请求来解决：

```python
llm_timeout: int = 60  # LLM调用的超时时间（秒）
step_timeout: int = 180  # 每个步骤的超时时间（秒）
```

### 资源竞争
资源竞争问题可能出现在多代理并发执行时。通过使用`BrowserManager`来管理浏览器会话，可以有效避免资源竞争：

```python
class BrowserManager:
    """管理多个代理的隔离浏览器会话。"""
    # ... 管理器代码
```

### LLM响应解析失败
LLM响应解析失败可能是由于响应格式不符合预期。可以通过修复JSON或增加错误处理来解决：

```python
from json_repair import repair_json
# ... 使用repair_json修复JSON
```

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L1-L1840)
- [tools.py](file://vibe_surf/tools/views.py#L1-L366)

## 性能监控与错误处理

### 性能监控
性能监控包括令牌使用情况、执行时间和资源消耗等。通过`TokenCost`服务可以获取详细的令牌使用摘要：

```python
token_summary = await state.vibesurf_agent.token_cost_service.get_usage_summary()
```

这些信息有助于优化代理的性能和成本。

### 错误处理
错误处理是确保系统稳定性的关键。VibeSurf系统通过捕获和记录异常来实现错误处理：

```python
except Exception as e:
    logger.error(f"❌ VibeSurf agent failed: {e}")
    # ... 错误处理代码
```

通过详细的错误日志和异常处理，可以快速定位和解决问题。

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L1-L1840)
- [main.py](file://vibe_surf/backend/main.py#L1-L794)
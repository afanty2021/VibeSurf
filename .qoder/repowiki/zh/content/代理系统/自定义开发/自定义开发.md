# è‡ªå®šä¹‰å¼€å‘

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**   
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py)
- [report_writer_agent.py](file://vibe_surf/agents/report_writer_agent.py)
- [vibesurf_tools.py](file://vibe_surf/tools/vibesurf_tools.py)
- [vibesurf_registry.py](file://vibe_surf/tools/vibesurf_registry.py)
- [browser_use_tools.py](file://vibe_surf/tools/browser_use_tools.py)
- [report_writer_tools.py](file://vibe_surf/tools/report_writer_tools.py)
- [views.py](file://vibe_surf/agents/views.py)
</cite>

## ç›®å½•
1. [å¼•è¨€](#å¼•è¨€)
2. [ä»£ç†ç³»ç»Ÿæ¶æ„](#ä»£ç†ç³»ç»Ÿæ¶æ„)
3. [ä»£ç†åŸºç±»ä½¿ç”¨æ–¹æ³•](#ä»£ç†åŸºç±»ä½¿ç”¨æ–¹æ³•)
4. [è‡ªå®šä¹‰ä»£ç†æ‰©å±•æ¥å£](#è‡ªå®šä¹‰ä»£ç†æ‰©å±•æ¥å£)
5. [è‡ªå®šä¹‰ä»£ç†æ³¨å†Œæœºåˆ¶](#è‡ªå®šä¹‰ä»£ç†æ³¨å†Œæœºåˆ¶)
6. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
7. [æµ‹è¯•ä¸è°ƒè¯•æ–¹æ³•](#æµ‹è¯•ä¸è°ƒè¯•æ–¹æ³•)
8. [æ€§èƒ½ä¼˜åŒ–å»ºè®®](#æ€§èƒ½ä¼˜åŒ–å»ºè®®)
9. [å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ)
10. [æœ€ä½³å®è·µæŒ‡å¯¼](#æœ€ä½³å®è·µæŒ‡å¯¼)

## å¼•è¨€
VibeSurfä»£ç†ç³»ç»Ÿæä¾›äº†ä¸€å¥—å®Œæ•´çš„è‡ªå®šä¹‰å¼€å‘æ¡†æ¶ï¼Œå…è®¸å¼€å‘è€…æ‰©å±•ç°æœ‰ä»£ç†åŠŸèƒ½æˆ–åˆ›å»ºå…¨æ–°çš„ä»£ç†ç±»å‹ã€‚æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜äº†å¦‚ä½•ä½¿ç”¨ä»£ç†åŸºç±»ã€æ‰©å±•æ¥å£ã€æ³¨å†Œæœºåˆ¶ä»¥åŠå®Œæ•´çš„å¼€å‘æµç¨‹ã€‚

## ä»£ç†ç³»ç»Ÿæ¶æ„
VibeSurfä»£ç†ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–æ¶æ„ï¼Œæ ¸å¿ƒç»„ä»¶åŒ…æ‹¬ä»£ç†åŸºç±»ã€å·¥å…·æ³¨å†Œè¡¨ã€æµè§ˆå™¨ç®¡ç†å™¨å’Œå„ç§ä¸“ç”¨ä»£ç†ã€‚ç³»ç»Ÿé€šè¿‡LangGraphå·¥ä½œæµåè°ƒä¸åŒä»£ç†çš„æ‰§è¡Œï¼Œå®ç°å¤æ‚çš„è‡ªåŠ¨åŒ–ä»»åŠ¡ã€‚

```mermaid
graph TD
A[VibeSurfAgent] --> B[BrowserManager]
A --> C[VibeSurfTools]
A --> D[TokenCost]
A --> E[ProductTelemetry]
B --> F[AgentBrowserSession]
C --> G[VibeSurfRegistry]
C --> H[BrowserUseTools]
C --> I[ReportWriterTools]
H --> J[BrowserUseAgent]
I --> K[ReportWriterAgent]
A --> L[VibeSurfState]
L --> M[LangGraph]
```

**Diagram sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L1-L130)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L83-L144)
- [report_writer_agent.py](file://vibe_surf/agents/report_writer_agent.py#L34-L46)
- [vibesurf_tools.py](file://vibe_surf/tools/vibesurf_tools.py#L72-L87)
- [vibesurf_registry.py](file://vibe_surf/tools/vibesurf_registry.py#L34-L53)

## ä»£ç†åŸºç±»ä½¿ç”¨æ–¹æ³•
VibeSurfç³»ç»Ÿæä¾›äº†å¤šä¸ªä»£ç†åŸºç±»ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿è¿™äº›åŸºç±»æ¥åˆ›å»ºè‡ªå®šä¹‰ä»£ç†ã€‚ä¸»è¦åŸºç±»åŒ…æ‹¬`VibeSurfAgent`ã€`BrowserUseAgent`å’Œ`ReportWriterAgent`ã€‚

### VibeSurfAgentåŸºç±»
`VibeSurfAgent`æ˜¯ç³»ç»Ÿçš„ä¸»è¦ä»£ç†åŸºç±»ï¼Œè´Ÿè´£åè°ƒå…¶ä»–ä»£ç†çš„æ‰§è¡Œã€‚å®ƒä½¿ç”¨LangGraphå·¥ä½œæµç®¡ç†ä»»åŠ¡æµï¼Œé€šè¿‡çŠ¶æ€æœºæ§åˆ¶ä»£ç†çš„æ‰§è¡Œæµç¨‹ã€‚

```mermaid
classDiagram
class VibeSurfAgent {
+llm : BaseChatModel
+browser_manager : BrowserManager
+tools : VibeSurfTools
+file_system : CustomFileSystem
+settings : VibeSurfAgentSettings
+token_cost_service : TokenCost
+telemetry : ProductTelemetry
+__init__(task : str, llm : BaseChatModel, browser_manager : BrowserManager, tools : VibeSurfTools, file_system_path : str)
+run(max_steps : int) VibeSurfState
+pause() void
+resume() void
+stop() void
}
```

**Diagram sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L83-L144)

### BrowserUseAgentåŸºç±»
`BrowserUseAgent`æ˜¯ä¸“é—¨ç”¨äºæµè§ˆå™¨è‡ªåŠ¨åŒ–ä»»åŠ¡çš„ä»£ç†åŸºç±»ã€‚å®ƒæä¾›äº†ä¸°å¯Œçš„æµè§ˆå™¨æ“ä½œåŠŸèƒ½ï¼ŒåŒ…æ‹¬é¡µé¢å¯¼èˆªã€å…ƒç´ äº¤äº’ã€å†…å®¹æå–ç­‰ã€‚

```mermaid
classDiagram
class BrowserUseAgent {
+task : str
+llm : BaseChatModel
+browser_session : BrowserSession
+tools : Tools
+settings : AgentSettings
+file_system : CustomFileSystem
+token_cost_service : TokenCost
+telemetry : ProductTelemetry
+__init__(task : str, llm : BaseChatModel, browser_session : BrowserSession, tools : Tools, file_system_path : str)
+run(max_steps : int) AgentHistoryList
+pause() void
+resume() void
+stop() void
+add_new_task(new_task : str) void
}
```

**Diagram sources**
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L83-L144)

### ReportWriterAgentåŸºç±»
`ReportWriterAgent`æ˜¯ç”¨äºç”ŸæˆæŠ¥å‘Šçš„ä»£ç†åŸºç±»ã€‚å®ƒä½¿ç”¨LLMé©±åŠ¨çš„æµç¨‹ç”ŸæˆHTMLæŠ¥å‘Šï¼Œæ”¯æŒè‡ªå®šä¹‰æŠ¥å‘Šæ¨¡æ¿å’Œæ ¼å¼ã€‚

```mermaid
classDiagram
class ReportWriterAgent {
+llm : BaseChatModel
+workspace_dir : str
+file_system : CustomFileSystem
+tools : ReportWriterTools
+telemetry : ProductTelemetry
+__init__(llm : BaseChatModel, workspace_dir : str, step_callback : Callable)
+generate_report(report_data : Dict[str, Any]) ReportTaskResult
+pause() void
+resume() void
+stop() void
+add_new_task(new_task : str) void
}
```

**Diagram sources**
- [report_writer_agent.py](file://vibe_surf/agents/report_writer_agent.py#L34-L46)

## è‡ªå®šä¹‰ä»£ç†æ‰©å±•æ¥å£
VibeSurfç³»ç»Ÿæä¾›äº†çµæ´»çš„æ‰©å±•æ¥å£ï¼Œå…è®¸å¼€å‘è€…é€šè¿‡å·¥å…·æ³¨å†Œè¡¨æ·»åŠ è‡ªå®šä¹‰åŠŸèƒ½ã€‚

### å·¥å…·æ³¨å†Œè¡¨
`VibeSurfRegistry`æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ‰©å±•æ¥å£ï¼Œç”¨äºæ³¨å†Œå’Œç®¡ç†è‡ªå®šä¹‰å·¥å…·ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿`VibeSurfRegistry`æ¥æ·»åŠ æ–°çš„å·¥å…·ç±»å‹ã€‚

```mermaid
classDiagram
class VibeSurfRegistry {
+registry : ActionRegistry
+exclude_actions : list[str]
+__init__(exclude_actions : list[str])
+action(description : str, param_model : type) Callable
+create_action_model(include_actions : list[str]) type[ActionModel]
+get_all_action_names(exclude_actions : list[str]) list[str]
+_get_special_param_types() dict[str, type]
}
```

**Diagram sources**
- [vibesurf_registry.py](file://vibe_surf/tools/vibesurf_registry.py#L34-L53)

### è‡ªå®šä¹‰å·¥å…·å¼€å‘
å¼€å‘è€…å¯ä»¥é€šè¿‡`VibeSurfTools`ç±»çš„æ³¨å†Œæœºåˆ¶æ·»åŠ è‡ªå®šä¹‰å·¥å…·ã€‚æ¯ä¸ªå·¥å…·éœ€è¦å®šä¹‰å‚æ•°æ¨¡å‹å’Œæ‰§è¡Œé€»è¾‘ã€‚

```python
@self.registry.action(
    'Custom action description',
    param_model=CustomActionModel,
)
async def custom_action(
    params: CustomActionModel,
    browser_manager: BrowserManager,
    page_extraction_llm: BaseChatModel,
    file_system: CustomFileSystem
):
    """
    Custom action implementation
    """
    try:
        # Action implementation
        result = await some_async_operation(params)
        return ActionResult(
            extracted_content=f"Custom action completed: {result}",
            include_in_memory=True,
            long_term_memory=f"Executed custom action with {params}"
        )
    except Exception as e:
        return ActionResult(error=f"Custom action failed: {str(e)}")
```

**Section sources**
- [vibesurf_tools.py](file://vibe_surf/tools/vibesurf_tools.py#L72-L87)

## è‡ªå®šä¹‰ä»£ç†æ³¨å†Œæœºåˆ¶
VibeSurfç³»ç»Ÿé€šè¿‡æµè§ˆå™¨ç®¡ç†å™¨ï¼ˆBrowserManagerï¼‰å®ç°ä»£ç†çš„æ³¨å†Œå’Œå‘ç°ã€‚æ¯ä¸ªä»£ç†åœ¨åˆ›å»ºæ—¶éƒ½ä¼šè¢«æ³¨å†Œåˆ°ç®¡ç†å™¨ä¸­ï¼Œä»¥ä¾¿è¿›è¡Œèµ„æºç®¡ç†å’Œåè°ƒã€‚

### ä»£ç†æ³¨å†Œæµç¨‹
1. åˆ›å»ºä»£ç†å®ä¾‹
2. è°ƒç”¨æµè§ˆå™¨ç®¡ç†å™¨çš„`register_agent`æ–¹æ³•
3. ç®¡ç†å™¨åˆ†é…æµè§ˆå™¨ä¼šè¯å’Œèµ„æº
4. ä»£ç†å¼€å§‹æ‰§è¡Œä»»åŠ¡

```mermaid
sequenceDiagram
participant Developer
participant VibeSurfAgent
participant BrowserManager
participant AgentBrowserSession
Developer->>VibeSurfAgent : åˆ›å»ºä»£ç†å®ä¾‹
VibeSurfAgent->>BrowserManager : register_agent(agent_id)
BrowserManager->>BrowserManager : æ£€æŸ¥ä»£ç†æ˜¯å¦å·²æ³¨å†Œ
alt ä»£ç†æœªæ³¨å†Œ
BrowserManager->>AgentBrowserSession : åˆ›å»ºæ–°ä¼šè¯
BrowserManager->>AgentBrowserSession : åˆå§‹åŒ–çœ‹é—¨ç‹—
BrowserManager->>BrowserManager : å­˜å‚¨ä»£ç†ä¼šè¯
else ä»£ç†å·²æ³¨å†Œ
BrowserManager->>BrowserManager : ä½¿ç”¨ç°æœ‰ä¼šè¯
end
BrowserManager->>VibeSurfAgent : è¿”å›ä»£ç†ä¼šè¯
VibeSurfAgent->>Developer : ä»£ç†å‡†å¤‡å°±ç»ª
```

**Diagram sources**
- [browser_manager.py](file://vibe_surf/browser/browser_manager.py#L47-L72)

### ä»£ç†å‘ç°æ–¹å¼
ç³»ç»Ÿé€šè¿‡ä»£ç†IDå’Œæµè§ˆå™¨ä¼šè¯IDæ¥å‘ç°å’Œç®¡ç†ä»£ç†ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å·²æ³¨å†Œçš„ä»£ç†ï¼š

```python
# è·å–å·²æ³¨å†Œçš„ä»£ç†
agent_session = browser_manager._agent_sessions.get(agent_id)
if agent_session:
    # ä½¿ç”¨ä»£ç†ä¼šè¯
    await agent_session.connect_agent(target_id=target_id)
```

**Section sources**
- [browser_manager.py](file://vibe_surf/browser/browser_manager.py#L47-L127)

## å®Œæ•´ä»£ç ç¤ºä¾‹
ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„è‡ªå®šä¹‰ä»£ç†å¼€å‘ç¤ºä¾‹ï¼Œå±•ç¤ºä»ä»£ç†ç±»å®šä¹‰åˆ°é…ç½®é›†æˆçš„å…¨è¿‡ç¨‹ã€‚

### è‡ªå®šä¹‰ä»£ç†ç±»å®šä¹‰
```python
from vibe_surf.agents.vibe_surf_agent import VibeSurfAgent
from vibe_surf.browser.browser_manager import BrowserManager
from vibe_surf.tools.vibesurf_tools import VibeSurfTools
from vibe_surf.tools.views import CustomActionModel
from browser_use.llm.base import BaseChatModel
from browser_use.llm.messages import UserMessage
from browser_use.browser.views import TabInfo
from browser_use.filesystem.file_system import FileSystem
from browser_use.agent.views import ActionResult

class CustomDataExtractorAgent(VibeSurfAgent):
    """
    è‡ªå®šä¹‰æ•°æ®æå–ä»£ç†
    ä¸“é—¨ç”¨äºä»ç½‘é¡µä¸­æå–ç»“æ„åŒ–æ•°æ®
    """
    
    def __init__(
        self,
        task: str,
        llm: BaseChatModel,
        browser_manager: BrowserManager,
        tools: VibeSurfTools,
        file_system_path: str = "./workspace"
    ):
        super().__init__(
            task=task,
            llm=llm,
            browser_manager=browser_manager,
            tools=tools,
            file_system_path=file_system_path
        )
        # åˆå§‹åŒ–è‡ªå®šä¹‰å±æ€§
        self.data_format = "json"
        self.extraction_rules = []
        
    async def _execute_extraction(self, query: str, tab_id: str = None):
        """
        æ‰§è¡Œæ•°æ®æå–æ“ä½œ
        """
        try:
            # è·å–å½“å‰æµè§ˆå™¨ä¸Šä¸‹æ–‡
            browser_tabs = await self.browser_manager.main_browser_session.get_tabs()
            active_tab = await self.browser_manager.get_activate_tab()
            
            # æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ä¿¡æ¯
            context_info = []
            context_info.append(f"å½“å‰æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            if browser_tabs:
                browser_tabs_info = {}
                for tab in browser_tabs:
                    browser_tabs_info[tab.target_id[-4:]] = {
                        "page_title": tab.title,
                        "page_url": tab.url,
                    }
                context_info.append(
                    f"å½“å‰å¯ç”¨æµè§ˆå™¨æ ‡ç­¾:\n{json.dumps(browser_tabs_info, ensure_ascii=False, indent=2)}\n")
            if active_tab:
                context_info.append(f"å½“å‰æ´»åŠ¨æµè§ˆå™¨æ ‡ç­¾:{active_tab.target_id[-4:]}\n")
                
            context_str = "\n".join(context_info) if context_info else "æ— é™„åŠ ä¸Šä¸‹æ–‡å¯ç”¨ã€‚"
            
            # æ·»åŠ ä¸Šä¸‹æ–‡åˆ°æ¶ˆæ¯å†å²
            self.message_history.append(UserMessage(content=context_str))
            
            # æ‰§è¡Œæå–æ“ä½œ
            result = await self.tools.act(
                action=CustomActionModel(query=query, tab_id=tab_id),
                browser_manager=self.browser_manager,
                llm=self.llm,
                file_system=self.file_system,
            )
            
            return result
            
        except Exception as e:
            logger.error(f"âŒ æ•°æ®æå–å¤±è´¥: {e}")
            return ActionResult(error=f"æ•°æ®æå–å¤±è´¥: {str(e)}")
```

### æ–¹æ³•å®ç°
```python
async def run_extraction_workflow(self, max_steps: int = 20):
    """
    æ‰§è¡Œæ•°æ®æå–å·¥ä½œæµ
    """
    logger.info("ğŸš€ å¼€å§‹æ‰§è¡Œæ•°æ®æå–å·¥ä½œæµ...")
    
    try:
        # åˆå§‹åŒ–çŠ¶æ€
        state = VibeSurfState(
            original_task=self.task,
            current_step="vibesurf_agent",
            vibesurf_agent=self
        )
        
        # æ‰§è¡Œä¸»å¾ªç¯
        for step in range(max_steps):
            if self.stopped:
                logger.info('ğŸ›‘ ä»£ç†å·²åœæ­¢')
                break
                
            logger.info(f"ğŸ”„ æ‰§è¡Œæ­¥éª¤ {step + 1}/{max_steps}...")
            
            # æ‰§è¡Œæå–æ“ä½œ
            result = await self._execute_extraction(self.task)
            
            if result.extracted_content:
                logger.info(f"âœ… æå–æˆåŠŸ: {result.extracted_content[:100]}...")
                break
                
            if result.error:
                logger.error(f"âŒ æå–å¤±è´¥: {result.error}")
                if step >= self.settings.max_failures:
                    break
                    
            # ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
            await asyncio.sleep(1)
            
        # è¿”å›æœ€ç»ˆçŠ¶æ€
        return state
        
    except Exception as e:
        logger.error(f"âŒ å·¥ä½œæµæ‰§è¡Œå¤±è´¥: {e}")
        raise
```

### é…ç½®é›†æˆ
```python
# é…ç½®æ–‡ä»¶: config.py
class AgentConfig:
    """
    ä»£ç†é…ç½®ç±»
    åŒ…å«æ‰€æœ‰ä»£ç†ç›¸å…³çš„é…ç½®å‚æ•°
    """
    
    # LLMé…ç½®
    LLM_MODEL = "gpt-4.1-mini"
    LLM_TIMEOUT = 90  # ç§’
    
    # æµè§ˆå™¨é…ç½®
    BROWSER_WAIT_BETWEEN_ACTIONS = 1.0  # ç§’
    BROWSER_DOWNLOAD_PATH = "./downloads"
    
    # ä»£ç†é…ç½®
    MAX_FAILURES = 3
    MAX_ACTIONS_PER_STEP = 4
    USE_VISION = True
    
    # æ–‡ä»¶ç³»ç»Ÿé…ç½®
    WORKSPACE_DIR = "./workspace"
    UPLOAD_DIR = "upload_files"
    DOWNLOAD_DIR = "downloads"
    
    # å·¥å…·é…ç½®
    ENABLE_BROWSER_TOOLS = True
    ENABLE_FILE_TOOLS = True
    ENABLE_REPORT_TOOLS = True
    
    # Telemetryé…ç½®
    ENABLE_TELEMETRY = True
    TELEMETRY_FLUSH_INTERVAL = 30  # ç§’
```

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L344-L546)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L659-L773)
- [report_writer_agent.py](file://vibe_surf/agents/report_writer_agent.py#L118-L316)

## æµ‹è¯•ä¸è°ƒè¯•æ–¹æ³•
VibeSurfç³»ç»Ÿæä¾›äº†å¤šç§æµ‹è¯•å’Œè°ƒè¯•å·¥å…·ï¼Œå¸®åŠ©å¼€å‘è€…éªŒè¯è‡ªå®šä¹‰ä»£ç†çš„åŠŸèƒ½å’Œæ€§èƒ½ã€‚

### å•å…ƒæµ‹è¯•
```python
import pytest
import asyncio
from unittest.mock import Mock, AsyncMock

class TestCustomDataExtractorAgent:
    """
    è‡ªå®šä¹‰æ•°æ®æå–ä»£ç†çš„å•å…ƒæµ‹è¯•
    """
    
    @pytest.fixture
    def mock_llm(self):
        """åˆ›å»ºLLMæ¨¡æ‹Ÿå¯¹è±¡"""
        llm = Mock()
        llm.ainvoke = AsyncMock()
        llm.model_name = "test-model"
        return llm
        
    @pytest.fixture
    def mock_browser_manager(self):
        """åˆ›å»ºæµè§ˆå™¨ç®¡ç†å™¨æ¨¡æ‹Ÿå¯¹è±¡"""
        manager = Mock()
        manager.main_browser_session = Mock()
        manager.main_browser_session.get_tabs = AsyncMock()
        manager.main_browser_session.get_current_page_title = AsyncMock()
        manager.get_activate_tab = AsyncMock()
        return manager
        
    @pytest.fixture
    def mock_tools(self):
        """åˆ›å»ºå·¥å…·æ¨¡æ‹Ÿå¯¹è±¡"""
        tools = Mock()
        tools.act = AsyncMock()
        tools.registry = Mock()
        tools.registry.create_action_model = Mock()
        return tools
        
    @pytest.mark.asyncio
    async def test_agent_initialization(self, mock_llm, mock_browser_manager, mock_tools):
        """æµ‹è¯•ä»£ç†åˆå§‹åŒ–"""
        # åˆ›å»ºä»£ç†å®ä¾‹
        agent = CustomDataExtractorAgent(
            task="æµ‹è¯•ä»»åŠ¡",
            llm=mock_llm,
            browser_manager=mock_browser_manager,
            tools=mock_tools,
            file_system_path="./test_workspace"
        )
        
        # éªŒè¯ä»£ç†å±æ€§
        assert agent.task == "æµ‹è¯•ä»»åŠ¡"
        assert agent.llm == mock_llm
        assert agent.browser_manager == mock_browser_manager
        assert agent.tools == mock_tools
        assert isinstance(agent.file_system, CustomFileSystem)
        
    @pytest.mark.asyncio
    async def test_extraction_workflow(self, mock_llm, mock_browser_manager, mock_tools):
        """æµ‹è¯•æå–å·¥ä½œæµ"""
        # è®¾ç½®æ¨¡æ‹Ÿè¿”å›å€¼
        mock_browser_manager.main_browser_session.get_tabs.return_value = [
            TabInfo(target_id="tab1", title="æµ‹è¯•é¡µé¢", url="https://example.com")
        ]
        mock_browser_manager.get_activate_tab.return_value = TabInfo(target_id="tab1", title="æµ‹è¯•é¡µé¢", url="https://example.com")
        mock_tools.act.return_value = ActionResult(extracted_content='{"data": "test"}')
        
        # åˆ›å»ºä»£ç†å®ä¾‹
        agent = CustomDataExtractorAgent(
            task="æå–æµ‹è¯•æ•°æ®",
            llm=mock_llm,
            browser_manager=mock_browser_manager,
            tools=mock_tools,
            file_system_path="./test_workspace"
        )
        
        # æ‰§è¡Œå·¥ä½œæµ
        state = await agent.run_extraction_workflow(max_steps=5)
        
        # éªŒè¯ç»“æœ
        assert state.is_complete == True
        assert state.final_response is not None
```

### è°ƒè¯•æŠ€å·§
1. **æ—¥å¿—è°ƒè¯•**ï¼šä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„æ—¥å¿—åŠŸèƒ½è·Ÿè¸ªä»£ç†æ‰§è¡Œè¿‡ç¨‹
2. **æ–­ç‚¹è°ƒè¯•**ï¼šåœ¨å…³é”®ä»£ç ä½ç½®è®¾ç½®æ–­ç‚¹è¿›è¡Œé€æ­¥è°ƒè¯•
3. **çŠ¶æ€æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ä»£ç†çŠ¶æ€å’Œå˜é‡å€¼
4. **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§ä»£ç†çš„èµ„æºä½¿ç”¨æƒ…å†µå’Œæ‰§è¡Œæ—¶é—´

```python
# è°ƒè¯•è¾…åŠ©å‡½æ•°
def debug_agent_state(agent):
    """è°ƒè¯•ä»£ç†çŠ¶æ€"""
    logger.debug(f"=== ä»£ç†çŠ¶æ€è°ƒè¯• ===")
    logger.debug(f"ä»£ç†ID: {agent.id}")
    logger.debug(f"ä»»åŠ¡: {agent.task}")
    logger.debug(f"å½“å‰æ­¥éª¤: {agent.current_step}")
    logger.debug(f"æ˜¯å¦åœæ­¢: {agent.stopped}")
    logger.debug(f"æ˜¯å¦æš‚åœ: {agent.paused}")
    logger.debug(f"è¿ç»­å¤±è´¥æ¬¡æ•°: {agent.consecutive_failures}")
    logger.debug(f"æ¶ˆæ¯å†å²é•¿åº¦: {len(agent.message_history)}")
    logger.debug(f"=====================")

# åœ¨ä»£ç†æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨
async def _execute_step(self, step, max_steps, step_info, on_step_start, on_step_end):
    """æ‰§è¡Œæ­¥éª¤"""
    # è°ƒè¯•çŠ¶æ€
    debug_agent_state(self)
    
    # æ‰§è¡ŒåŸæœ‰é€»è¾‘
    # ...
```

**Section sources**
- [test_agents.py](file://tests/test_agents.py)
- [test_tools.py](file://tests/test_tools.py)

## æ€§èƒ½ä¼˜åŒ–å»ºè®®
ä¸ºäº†ç¡®ä¿è‡ªå®šä¹‰ä»£ç†çš„é«˜æ•ˆè¿è¡Œï¼Œä»¥ä¸‹æ˜¯æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³å®è·µã€‚

### èµ„æºç®¡ç†
1. **å†…å­˜ä¼˜åŒ–**ï¼šåŠæ—¶æ¸…ç†ä¸å†éœ€è¦çš„å¯¹è±¡å’Œç¼“å­˜
2. **è¿æ¥æ± **ï¼šå¤ç”¨æµè§ˆå™¨ä¼šè¯å’Œç½‘ç»œè¿æ¥
3. **æ–‡ä»¶ç®¡ç†**ï¼šåˆç†ç»„ç»‡æ–‡ä»¶ç³»ç»Ÿï¼Œé¿å…æ–‡ä»¶è¿‡å¤š

```python
class OptimizedCustomAgent(VibeSurfAgent):
    """
    ä¼˜åŒ–çš„è‡ªå®šä¹‰ä»£ç†
    å®ç°äº†èµ„æºç®¡ç†å’Œæ€§èƒ½ä¼˜åŒ–
    """
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # åˆå§‹åŒ–èµ„æºæ± 
        self._resource_pool = {}
        self._cache = {}
        self._max_cache_size = 100
        
    async def cleanup_resources(self):
        """æ¸…ç†èµ„æº"""
        # æ¸…ç†ç¼“å­˜
        if len(self._cache) > self._max_cache_size:
            # ä¿ç•™æœ€è¿‘ä½¿ç”¨çš„ç¼“å­˜é¡¹
            recent_keys = list(self._cache.keys())[-50:]
            self._cache = {k: v for k, v in self._cache.items() if k in recent_keys}
            
        # æ¸…ç†ç©ºé—²èµ„æº
        for key, resource in list(self._resource_pool.items()):
            if resource.is_idle():
                await resource.cleanup()
                del self._resource_pool[key]
                
    async def get_cached_result(self, key):
        """è·å–ç¼“å­˜ç»“æœ"""
        return self._cache.get(key)
        
    async def cache_result(self, key, value):
        """ç¼“å­˜ç»“æœ"""
        self._cache[key] = value
        # å®šæœŸæ¸…ç†ç¼“å­˜
        if len(self._cache) % 10 == 0:
            await self.cleanup_resources()
```

### æ‰§è¡Œæ•ˆç‡æå‡
1. **å¼‚æ­¥ä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿
2. **æ‰¹é‡å¤„ç†**ï¼šåˆå¹¶å¤šä¸ªæ“ä½œä¸ºæ‰¹é‡å¤„ç†
3. **å¹¶è¡Œæ‰§è¡Œ**ï¼šåœ¨å®‰å…¨çš„å‰æä¸‹å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹ä»»åŠ¡

```python
async def execute_parallel_tasks(self, tasks):
    """
    å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡
    """
    # åˆ›å»ºä»»åŠ¡åˆ—è¡¨
    coroutines = []
    for task in tasks:
        coroutine = self._execute_single_task(task)
        coroutines.append(coroutine)
        
    # å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
    results = await asyncio.gather(*coroutines, return_exceptions=True)
    
    # å¤„ç†ç»“æœ
    successful_results = []
    for i, result in enumerate(results):
        if isinstance(result, Exception):
            logger.error(f"ä»»åŠ¡ {i} æ‰§è¡Œå¤±è´¥: {result}")
        else:
            successful_results.append(result)
            
    return successful_results
```

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L548-L605)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L607-L763)

## å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
ä»¥ä¸‹æ˜¯å¼€å‘è¿‡ç¨‹ä¸­å¸¸è§çš„é—®é¢˜åŠå…¶è§£å†³æ–¹æ¡ˆã€‚

### é—®é¢˜1ï¼šä»£ç†æ— æ³•å¯åŠ¨
**ç—‡çŠ¶**ï¼šä»£ç†åˆå§‹åŒ–å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
**åŸå› **ï¼šç¼ºå°‘å¿…è¦çš„ä¾èµ–æˆ–é…ç½®é”™è¯¯
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥LLMé…ç½®æ˜¯å¦æ­£ç¡®
2. éªŒè¯æµè§ˆå™¨ç®¡ç†å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. ç¡®è®¤æ–‡ä»¶ç³»ç»Ÿè·¯å¾„å¯è®¿é—®

```python
def validate_agent_configuration(self):
    """éªŒè¯ä»£ç†é…ç½®"""
    errors = []
    
    # æ£€æŸ¥LLM
    if not self.llm:
        errors.append("LLMæœªé…ç½®")
        
    # æ£€æŸ¥æµè§ˆå™¨ç®¡ç†å™¨
    if not self.browser_manager:
        errors.append("æµè§ˆå™¨ç®¡ç†å™¨æœªé…ç½®")
    elif not hasattr(self.browser_manager, 'main_browser_session'):
        errors.append("æµè§ˆå™¨ç®¡ç†å™¨ç¼ºå°‘ä¸»ä¼šè¯")
        
    # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
    if not self.file_system:
        errors.append("æ–‡ä»¶ç³»ç»Ÿæœªé…ç½®")
    else:
        try:
            test_path = self.file_system.get_dir() / "test.txt"
            with open(test_path, 'w') as f:
                f.write("test")
            os.remove(test_path)
        except Exception as e:
            errors.append(f"æ–‡ä»¶ç³»ç»Ÿä¸å¯å†™: {e}")
            
    return errors
```

### é—®é¢˜2ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥
**ç—‡çŠ¶**ï¼šå·¥å…·è°ƒç”¨è¿”å›é”™è¯¯
**åŸå› **ï¼šå‚æ•°é”™è¯¯æˆ–ç¯å¢ƒé—®é¢˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. éªŒè¯å‚æ•°ç±»å‹å’Œæ ¼å¼
2. æ£€æŸ¥æµè§ˆå™¨ä¼šè¯çŠ¶æ€
3. ç¡®è®¤LLMæœåŠ¡å¯ç”¨

```python
async def robust_tool_execution(self, action, **kwargs):
    """
    å¥å£®çš„å·¥å…·æ‰§è¡Œ
    åŒ…å«é‡è¯•æœºåˆ¶å’Œé”™è¯¯å¤„ç†
    """
    max_retries = 3
    retry_delay = 1.0
    
    for attempt in range(max_retries):
        try:
            # æ‰§è¡Œå·¥å…·
            result = await self.tools.act(action, **kwargs)
            
            # æ£€æŸ¥ç»“æœ
            if result.error:
                logger.warning(f"å·¥å…·æ‰§è¡Œè¿”å›é”™è¯¯ (å°è¯• {attempt + 1}): {result.error}")
                if attempt < max_retries - 1:
                    await asyncio.sleep(retry_delay * (attempt + 1))
                    continue
                return result
            else:
                return result
                
        except Exception as e:
            logger.error(f"å·¥å…·æ‰§è¡Œå¼‚å¸¸ (å°è¯• {attempt + 1}): {e}")
            if attempt < max_retries - 1:
                await asyncio.sleep(retry_delay * (attempt + 1))
            else:
                return ActionResult(error=f"å·¥å…·æ‰§è¡Œå¤±è´¥: {str(e)}")
```

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L522-L545)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L721-L734)

## æœ€ä½³å®è·µæŒ‡å¯¼
éµå¾ªä»¥ä¸‹æœ€ä½³å®è·µå¯ä»¥ç¡®ä¿è‡ªå®šä¹‰ä»£ç†çš„é«˜è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚

### ä»£ç ç»„ç»‡
1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå°†åŠŸèƒ½åˆ†è§£ä¸ºç‹¬ç«‹çš„æ¨¡å—
2. **æ¸…æ™°çš„å‘½å**ï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„å˜é‡å’Œå‡½æ•°å
3. **æ–‡æ¡£æ³¨é‡Š**ï¼šä¸ºç±»å’Œæ–¹æ³•æ·»åŠ è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Š

```python
class WellStructuredCustomAgent(VibeSurfAgent):
    """
    ç»“æ„è‰¯å¥½çš„è‡ªå®šä¹‰ä»£ç†
    éµå¾ªæœ€ä½³å®è·µçš„ä»£ç ç»„ç»‡
    """
    
    def __init__(self, *args, **kwargs):
        """
        åˆå§‹åŒ–ä»£ç†
        
        Args:
            task: ä»£ç†ä»»åŠ¡æè¿°
            llm: è¯­è¨€æ¨¡å‹å®ä¾‹
            browser_manager: æµè§ˆå™¨ç®¡ç†å™¨å®ä¾‹
            tools: å·¥å…·å®ä¾‹
            file_system_path: æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
        """
        super().__init__(*args, **kwargs)
        self._initialize_components()
        
    def _initialize_components(self):
        """åˆå§‹åŒ–ç»„ä»¶"""
        self._setup_message_history()
        self._configure_settings()
        self._register_callbacks()
        
    def _setup_message_history(self):
        """è®¾ç½®æ¶ˆæ¯å†å²"""
        self.message_history = []
        system_message = self._generate_system_prompt()
        self.message_history.append(SystemMessage(content=system_message))
        
    def _configure_settings(self):
        """é…ç½®è®¾ç½®"""
        self.settings = VibeSurfAgentSettings(
            use_vision=True,
            max_failures=3,
            max_actions_per_step=4,
            agent_mode="thinking"
        )
```

### é”™è¯¯å¤„ç†
1. **å…¨é¢çš„å¼‚å¸¸æ•è·**ï¼šæ•è·æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
2. **æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯**ï¼šæä¾›è¯¦ç»†çš„é”™è¯¯æè¿°
3. **ä¼˜é›…çš„é™çº§**ï¼šåœ¨é”™è¯¯å‘ç”Ÿæ—¶æä¾›å¤‡é€‰æ–¹æ¡ˆ

```python
async def safe_execute_with_fallback(self, primary_func, fallback_func, *args, **kwargs):
    """
    å®‰å…¨æ‰§è¡Œå¸¦é™çº§çš„å‡½æ•°
    
    Args:
        primary_func: ä¸»è¦æ‰§è¡Œå‡½æ•°
        fallback_func: é™çº§æ‰§è¡Œå‡½æ•°
        *args, **kwargs: å‡½æ•°å‚æ•°
        
    Returns:
        æ‰§è¡Œç»“æœ
    """
    try:
        # å°è¯•ä¸»è¦åŠŸèƒ½
        result = await primary_func(*args, **kwargs)
        return result
        
    except Exception as e:
        logger.warning(f"ä¸»è¦åŠŸèƒ½æ‰§è¡Œå¤±è´¥: {e}, å°è¯•é™çº§æ–¹æ¡ˆ")
        
        try:
            # æ‰§è¡Œé™çº§æ–¹æ¡ˆ
            result = await fallback_func(*args, **kwargs)
            logger.info("é™çº§æ–¹æ¡ˆæ‰§è¡ŒæˆåŠŸ")
            return result
            
        except Exception as fallback_error:
            logger.error(f"é™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥: {fallback_error}")
            raise RuntimeError(f"æ‰€æœ‰æ‰§è¡Œæ–¹æ¡ˆå‡å¤±è´¥: {e}, {fallback_error}")
```

**Section sources**
- [vibe_surf_agent.py](file://vibe_surf/agents/vibe_surf_agent.py#L344-L546)
- [browser_use_agent.py](file://vibe_surf/agents/browser_use_agent.py#L659-L773)
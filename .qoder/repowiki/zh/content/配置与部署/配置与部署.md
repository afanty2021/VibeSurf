# 配置与部署

<cite>
**本文档中引用的文件**   
- [.env.example](file://.env.example)
- [pyproject.toml](file://pyproject.toml)
- [vibe_surf/backend/main.py](file://vibe_surf/backend/main.py)
- [vibe_surf/backend/database/manager.py](file://vibe_surf/backend/database/manager.py)
- [vibe_surf/backend/shared_state.py](file://vibe_surf/backend/shared_state.py)
- [vibe_surf/backend/utils/utils.py](file://vibe_surf/backend/utils/utils.py)
- [vibe_surf/common.py](file://vibe_surf/common.py)
- [vibe_surf/frontend/Dockerfile](file://vibe_surf/frontend/Dockerfile)
- [vibe_surf/frontend/nginx.conf](file://vibe_surf/frontend/nginx.conf)
- [vibe_surf/frontend/start-nginx.sh](file://vibe_surf/frontend/start-nginx.sh)
- [vibe_surf/frontend/package.json](file://vibe_surf/frontend/package.json)
</cite>

## 目录
1. [环境配置](#环境配置)
2. [生产部署最佳实践](#生产部署最佳实践)
3. [扩展配置指南](#扩展配置指南)
4. [监控和日志配置](#监控和日志配置)
5. [安全加固建议](#安全加固建议)
6. [不同规模部署的参考架构](#不同规模部署的参考架构)

## 环境配置

VibeSurf的环境配置主要通过环境变量进行管理，这些变量定义了系统行为、API连接、日志级别等关键参数。配置文件`.env.example`提供了所有必需环境变量的模板。

### 环境变量含义与推荐设置

以下是VibeSurf核心环境变量的详细说明：

#### LLM服务配置
- **OPENAI_ENDPOINT**: OpenAI API端点URL，默认为`https://api.openai.com/v1`
- **OPENAI_API_KEY**: OpenAI API密钥，用于访问OpenAI服务
- **ANTHROPIC_ENDPOINT**: Anthropic API端点URL，默认为`https://api.anthropic.com`
- **ANTHROPIC_API_KEY**: Anthropic API密钥
- **AZURE_OPENAI_ENDPOINT**: Azure OpenAI服务端点
- **AZURE_OPENAI_API_KEY**: Azure OpenAI API密钥
- **AZURE_OPENAI_API_VERSION**: Azure OpenAI API版本，默认为`2025-01-01-preview`
- **DEEPSEEK_ENDPOINT**: DeepSeek API端点
- **DEEPSEEK_API_KEY**: DeepSeek API密钥
- **MISTRAL_API_KEY**: Mistral API密钥
- **MISTRAL_ENDPOINT**: Mistral API端点
- **OLLAMA_ENDPOINT**: Ollama服务端点，默认为`http://localhost:11434`
- **DASHSCOPE_ENDPOINT**: 阿里云通义千问API端点
- **DASHSCOPE_API_KEY**: 阿里云API密钥
- **MOONSHOT_ENDPOINT**: Moonshot API端点
- **MOONSHOT_API_KEY**: Moonshot API密钥
- **UNBOUND_ENDPOINT**: Unbound API端点
- **UNBOUND_API_KEY**: Unbound API密钥
- **SiliconFLOW_ENDPOINT**: SiliconFlow API端点
- **SiliconFLOW_API_KEY**: SiliconFlow API密钥

#### 系统与浏览器配置
- **ANONYMIZED_TELEMETRY**: 是否启用匿名遥测，默认为`false`
- **BROWSER_USE_LOGGING_LEVEL**: 浏览器使用日志级别，可选值：`result`、`debug`、`info`，默认为`info`
- **BROWSER_USE_CALCULATE_COST**: 是否计算token成本，默认为`false`
- **IN_DOCKER**: 是否在Docker容器中运行，用于优化Chrome配置，默认为`false`
- **VIBESURF_BACKEND_PORT**: VibeSurf后端端口
- **VIBESURF_EXTENSION**: VibeSurf Chrome扩展路径
- **VIBESURF_WORKSPACE**: 工作区目录路径
- **VIBESURF_DATABASE_URL**: 数据库连接URL
- **VIBESURF_DEBUG**: 调试模式开关
- **VIBESURF_ANONYMIZED_TELEMETRY**: VibeSurf匿名遥测开关，默认为`true`
- **BROWSER_EXECUTION_PATH**: 浏览器执行路径
- **BROWSER_USER_DATA**: 浏览器用户数据目录
- **COMPOSIO_API_KEY**: Composio集成API密钥

#### 推荐设置
对于生产环境，建议：
1. 设置`IN_DOCKER=true`以优化容器内浏览器性能
2. 配置`VIBESURF_DATABASE_URL`指向持久化数据库（如PostgreSQL）
3. 设置`VIBESURF_DEBUG=false`以禁用调试模式
4. 配置`BROWSER_EXECUTION_PATH`和`BROWSER_USER_DATA`以确保浏览器正确运行
5. 为所有LLM服务配置有效的API密钥

**Section sources**
- [.env.example](file://.env.example)
- [vibe_surf/backend/shared_state.py](file://vibe_surf/backend/shared_state.py)
- [vibe_surf/common.py](file://vibe_surf/common.py)

## 生产部署最佳实践

### Docker容器化部署

VibeSurf支持通过Docker进行容器化部署，前端和后端分别有独立的Docker配置。

#### 前端Docker配置
前端使用多阶段Docker构建，首先使用Node.js镜像构建应用，然后使用Nginx作为生产服务器。

```dockerfile
FROM node:20-alpine as frontend_build
ARG BACKEND_URL
WORKDIR /app

COPY ./package.json ./package-lock.json ./tsconfig.json ./vite.config.ts ./index.html ./tailwind.config.js ./postcss.config.js ./prettier.config.js /app/
RUN npm install
COPY ./src /app/src
RUN npm run build

FROM nginx
COPY --from=frontend_build /app/build/ /usr/share/nginx/html
COPY /nginx.conf /etc/nginx/conf.d/default.conf
COPY start-nginx.sh /start-nginx.sh
RUN chmod +x /start-nginx.sh
ENV BACKEND_URL=$BACKEND_URL
CMD ["/start-nginx.sh"]
```

#### Nginx配置
Nginx配置文件定义了静态文件服务和反向代理规则：

```nginx
server {
    gzip on;
    gzip_comp_level  2;
    gzip_min_length  1000;
    gzip_types  text/xml text/css;
    gzip_http_version 1.1;
    gzip_vary  on;
    gzip_disable "MSIE [4-6] \.";

    listen 80;

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
        try_files $uri $uri/ /index.html =404;
    }

    include /etc/nginx/extra-conf.d/*.conf;
}
```

#### 启动脚本
启动脚本动态替换Nginx配置中的后端URL：

```bash
#!/bin/sh

# Replace the placeholder with the actual value
sed -i "s|__BACKEND_URL__|$BACKEND_URL|g" /etc/nginx/conf.d/default.conf

# Start nginx
exec nginx -g 'daemon off;'
```

### Kubernetes编排

对于Kubernetes部署，建议使用以下配置模式：
1. 将前端和后端作为独立的Deployment部署
2. 使用Service暴露后端API
3. 使用Ingress控制器管理外部访问
4. 配置持久化存储卷用于数据库和工作区
5. 设置资源限制和请求以优化资源使用

### 云服务部署（AWS、GCP）

在AWS和GCP上部署VibeSurf时，建议：
- **AWS**: 使用ECS或EKS进行容器编排，RDS作为数据库，S3作为持久化存储
- **GCP**: 使用GKE进行Kubernetes编排，Cloud SQL作为数据库，Cloud Storage作为持久化存储
- 配置适当的IAM角色和安全组
- 使用云原生监控和日志服务

**Section sources**
- [vibe_surf/frontend/Dockerfile](file://vibe_surf/frontend/Dockerfile)
- [vibe_surf/frontend/nginx.conf](file://vibe_surf/frontend/nginx.conf)
- [vibe_surf/frontend/start-nginx.sh](file://vibe_surf/frontend/start-nginx.sh)
- [vibe_surf/frontend/package.json](file://vibe_surf/frontend/package.json)

## 扩展配置指南

### 水平扩展

VibeSurf支持通过以下方式实现水平扩展：
1. **无状态后端**: 后端服务设计为无状态，可通过负载均衡器分发请求
2. **共享数据库**: 使用集中式数据库（如PostgreSQL）确保数据一致性
3. **分布式缓存**: 配置Redis等分布式缓存服务提高性能

### 负载均衡

建议使用以下负载均衡策略：
- 在前端部署Nginx或HAProxy作为反向代理
- 配置会话保持（session affinity）确保用户会话一致性
- 设置健康检查确保服务可用性

### 高可用性设置

为实现高可用性，建议：
1. **多区域部署**: 在不同地理区域部署实例
2. **自动故障转移**: 配置自动故障转移机制
3. **数据备份**: 定期备份数据库和工作区数据
4. **监控告警**: 设置全面的监控和告警系统

**Section sources**
- [vibe_surf/backend/main.py](file://vibe_surf/backend/main.py)
- [vibe_surf/backend/database/manager.py](file://vibe_surf/backend/database/manager.py)

## 监控和日志配置

### Prometheus集成

VibeSurf通过以下方式支持Prometheus监控：
- 在`pyproject.toml`中包含`opentelemetry-exporter-prometheus`依赖
- 配置OpenTelemetry SDK导出指标到Prometheus
- 暴露`/metrics`端点供Prometheus抓取

### Grafana集成

Grafana可以连接Prometheus数据源，创建以下仪表板：
- 系统性能监控
- 请求延迟和错误率
- 数据库性能指标
- LLM调用统计

### ELK堆栈集成

日志配置支持ELK（Elasticsearch, Logstash, Kibana）堆栈：
- 使用`structlog`和`loguru`进行结构化日志记录
- 配置日志输出格式便于ELK解析
- 支持将日志发送到Elasticsearch

**Section sources**
- [pyproject.toml](file://pyproject.toml)
- [vibe_surf/backend/main.py](file://vibe_surf/backend/main.py)

## 安全加固建议

### 防火墙设置

建议的防火墙配置：
- 仅开放必要的端口（如80、443、9335）
- 配置IP白名单限制访问
- 使用WAF（Web应用防火墙）防护常见攻击

### SSL/TLS配置

强制实施SSL/TLS：
- 配置Nginx或负载均衡器终止SSL
- 使用Let's Encrypt等服务获取免费证书
- 强制HTTP到HTTPS重定向
- 配置HSTS（HTTP严格传输安全）

### 安全更新策略

实施安全更新策略：
- 定期更新依赖包
- 监控安全漏洞公告
- 使用`pyproject.toml`锁定依赖版本
- 实施CI/CD管道中的安全扫描

**Section sources**
- [vibe_surf/backend/main.py](file://vibe_surf/backend/main.py)
- [vibe_surf/backend/utils/utils.py](file://vibe_surf/backend/utils/utils.py)

## 不同规模部署的参考架构

### 小型个人部署

适用于个人用户或开发环境：
- 单机部署，使用SQLite作为数据库
- 本地运行，无需容器化
- 使用默认LLM配置
- 工作区存储在本地文件系统

### 中型企业部署

适用于团队协作环境：
- Docker容器化部署
- PostgreSQL作为生产数据库
- Redis作为缓存
- 配置多个LLM提供商实现冗余
- 使用Nginx作为反向代理

### 大型企业级部署

适用于大规模生产环境：
- Kubernetes集群部署
- 多区域高可用架构
- 专用数据库实例（如AWS RDS或GCP Cloud SQL）
- 分布式缓存（如Redis Cluster）
- 全面的监控和告警系统
- 自动扩展策略
- 严格的访问控制和审计

**Section sources**
- [vibe_surf/backend/main.py](file://vibe_surf/backend/main.py)
- [vibe_surf/backend/database/manager.py](file://vibe_surf/backend/database/manager.py)
- [vibe_surf/backend/shared_state.py](file://vibe_surf/backend/shared_state.py)
# 上下文管理

<cite>
**本文档中引用的文件**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)
- [auth.ts](file://vibe_surf/frontend/src/types/contexts/auth.ts)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)
- [storeStore.ts](file://vibe_surf/frontend/src/stores/storeStore.ts)
- [routes.tsx](file://vibe_surf/frontend/src/routes.tsx)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概述](#架构概述)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)

## 项目结构

VibeSurf前端的上下文管理主要位于`src/contexts`目录下，通过React Context API实现全局状态管理。核心文件包括`authContext.tsx`和`index.tsx`，分别负责认证上下文的定义和所有上下文的统一包装。

```mermaid
graph TD
A[src/contexts] --> B[authContext.tsx]
A --> C[index.tsx]
B --> D[AuthContext]
B --> E[AuthProvider]
C --> F[ContextWrapper]
F --> G[AuthProvider]
F --> H[QueryClientProvider]
F --> I[ReactFlowProvider]
```

**图示来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)

**本节来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)

## 核心组件

VibeSurf前端上下文管理的核心是`AuthContext`，它通过React Context API提供全局认证状态管理。该上下文与Zustand store协同工作，实现了复杂的认证逻辑和状态同步。

**本节来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)

## 架构概述

VibeSurf的上下文管理架构采用分层设计，将React Context与Zustand store结合使用。`AuthContext`作为顶层状态管理器，负责提供认证相关的数据和方法，而Zustand store则用于管理更复杂的业务状态。

```mermaid
graph TD
A[AuthContext] --> B[accessToken]
A --> C[userData]
A --> D[apiKey]
A --> E[login]
A --> F[getUser]
A --> G[storeApiKey]
B --> H[Cookie]
B --> I[LocalStorage]
C --> J[API调用]
D --> K[Cookie]
E --> L[认证流程]
F --> M[用户数据获取]
G --> N[API密钥存储]
```

**图示来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)

## 详细组件分析

### AuthContext分析

`AuthContext`是VibeSurf前端认证系统的核心，它通过React Context API提供全局可访问的认证状态和方法。

#### 类图
```mermaid
classDiagram
class AuthContextType {
+accessToken : string | null
+login(accessToken : string, autoLogin : string, refreshToken? : string) : void
+userData : Users | null
+setUserData(userData : Users | null) : void
+authenticationErrorCount : number
+apiKey : string | null
+setApiKey(apiKey : string | null) : void
+storeApiKey(apiKey : string) : void
+getUser() : void
}
class AuthContext {
+Provider : AuthProvider
+Consumer : AuthConsumer
}
class AuthProvider {
-cookies : Cookies
-accessToken : string | null
-userData : Users | null
-apiKey : string | null
+login(newAccessToken : string, autoLogin : string, refreshToken? : string) : void
+getUser() : void
+storeApiKey(apikey : string) : void
+getGlobalVariables() : void
}
AuthContextType <|-- AuthProvider : "实现"
AuthContext <|-- AuthProvider : "提供"
```

**图示来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [auth.ts](file://vibe_surf/frontend/src/types/contexts/auth.ts)

#### 认证流程序列图
```mermaid
sequenceDiagram
participant LoginForm as "登录表单"
participant AuthProvider as "AuthProvider"
participant AuthStore as "AuthStore"
participant API as "后端API"
LoginForm->>AuthProvider : login(accessToken, autoLogin, refreshToken)
AuthProvider->>AuthProvider : setAuthCookie(accessToken)
AuthProvider->>AuthProvider : setLocalStorage(accessToken)
AuthProvider->>AuthStore : setIsAuthenticated(true)
AuthProvider->>AuthProvider : getUser()
AuthProvider->>API : mutateLoggedUser()
API-->>AuthProvider : 用户数据
AuthProvider->>AuthProvider : setUserData(user)
AuthProvider->>AuthStore : setIsAdmin(isSuperUser)
AuthProvider->>AuthProvider : checkHasStore()
AuthProvider->>AuthProvider : fetchApiData()
AuthProvider->>AuthProvider : getGlobalVariables()
AuthProvider-->>LoginForm : 登录完成
```

**图示来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)

#### 上下文类型定义
```mermaid
erDiagram
AUTH_CONTEXT_TYPE {
string accessToken
function login
object userData
function setUserData
number authenticationErrorCount
string apiKey
function setApiKey
function storeApiKey
function getUser
}
USERS {
string id
string email
string username
boolean is_superuser
timestamp created_at
timestamp updated_at
}
AUTH_CONTEXT_TYPE ||--o{ USERS : "包含"
```

**图示来源**  
- [auth.ts](file://vibe_surf/frontend/src/types/contexts/auth.ts)
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)

### ContextWrapper分析

`ContextWrapper`是VibeSurf前端所有上下文的统一包装器，它将多个上下文Provider组合在一起，为整个应用提供统一的上下文环境。

#### ContextWrapper类图
```mermaid
classDiagram
class ContextWrapper {
+QueryClientProvider
+AuthProvider
+TooltipProvider
+ReactFlowProvider
+ApiInterceptor
}
class QueryClientProvider {
+client : QueryClient
}
class AuthProvider {
+value : AuthContextType
}
class TooltipProvider {
+skipDelayDuration : number
}
class ReactFlowProvider {
}
class ApiInterceptor {
}
ContextWrapper --> QueryClientProvider
ContextWrapper --> AuthProvider
ContextWrapper --> TooltipProvider
ContextWrapper --> ReactFlowProvider
ContextWrapper --> ApiInterceptor
```

**图示来源**  
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)

**本节来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)
- [storeStore.ts](file://vibe_surf/frontend/src/stores/storeStore.ts)

## 依赖分析

VibeSurf的上下文管理依赖于多个外部库和内部模块，形成了复杂的依赖关系网络。

```mermaid
graph TD
A[React Context] --> B[authContext.tsx]
C[Zustand] --> D[authStore.ts]
C --> E[storeStore.ts]
F[react-cookie] --> B
G[@tanstack/react-query] --> H[index.tsx]
H --> B
I[@xyflow/react] --> H
J[authContext.tsx] --> K[controllers/API/queries]
J --> L[utils/utils]
J --> M[constants/constants]
N[storeStore.ts] --> O[controllers/API]
P[routes.tsx] --> H
```

**图示来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)
- [storeStore.ts](file://vibe_surf/frontend/src/stores/storeStore.ts)
- [routes.tsx](file://vibe_surf/frontend/src/routes.tsx)

**本节来源**  
- [authContext.tsx](file://vibe_surf/frontend/src/contexts/authContext.tsx)
- [index.tsx](file://vibe_surf/frontend/src/contexts/index.tsx)
- [authStore.ts](file://vibe_surf/frontend/src/stores/authStore.ts)
- [storeStore.ts](file://vibe_surf/frontend/src/stores/storeStore.ts)
- [routes.tsx](file://vibe_surf/frontend/src/routes.tsx)
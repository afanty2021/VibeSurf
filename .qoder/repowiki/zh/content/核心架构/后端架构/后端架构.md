# 后端架构

<cite>
**本文档引用的文件**   
- [main.py](file://vibe_surf/backend/main.py)
- [shared_state.py](file://vibe_surf/backend/shared_state.py)
- [task.py](file://vibe_surf/backend/api/task.py)
- [composio.py](file://vibe_surf/backend/api/composio.py)
- [browser.py](file://vibe_surf/backend/api/browser.py)
- [config.py](file://vibe_surf/backend/api/config.py)
- [models.py](file://vibe_surf/backend/api/models.py)
- [manager.py](file://vibe_surf/backend/database/manager.py)
- [models.py](file://vibe_surf/backend/database/models.py)
- [queries.py](file://vibe_surf/backend/database/queries.py)
- [llm_factory.py](file://vibe_surf/backend/utils/llm_factory.py)
- [encryption.py](file://vibe_surf/backend/utils/encryption.py)
- [utils.py](file://vibe_surf/backend/utils/utils.py)
- [llm_config.py](file://vibe_surf/backend/llm_config.py)
- [voice_model_config.py](file://vibe_surf/backend/voice_model_config.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [API端点组织](#api端点组织)
4. [业务逻辑层实现](#业务逻辑层实现)
5. [数据库访问模式](#数据库访问模式)
6. [中间件配置](#中间件配置)
7. [代理系统协调](#代理系统协调)
8. [浏览器管理](#浏览器管理)
9. [LLM调用机制](#llm调用机制)
10. [模块化设计](#模块化设计)
11. [并发请求处理](#并发请求处理)
12. [数据库会话管理](#数据库会话管理)
13. [安全认证机制](#安全认证机制)
14. [性能优化策略](#性能优化策略)
15. [错误处理策略](#错误处理策略)

## 项目结构

VibeSurf后端采用模块化设计，主要目录包括api、database、utils等。api目录包含所有API路由，database目录负责数据库操作，utils目录提供工具函数。后端基于FastAPI框架，实现了单任务执行模型与Langflow集成。

```mermaid
graph TD
backend[vibe_surf/backend]
backend --> api[api]
backend --> database[database]
backend --> utils[utils]
backend --> llm_config[llm_config.py]
backend --> voice_model_config[voice_model_config.py]
backend --> main[main.py]
backend --> shared_state[shared_state.py]
api --> task[task.py]
api --> composio[composio.py]
api --> browser[browser.py]
api --> config[config.py]
api --> models[models.py]
database --> manager[manager.py]
database --> models[models.py]
database --> queries[queries.py]
database --> migrations[migrations/]
utils --> llm_factory[llm_factory.py]
utils --> encryption[encryption.py]
utils --> utils[utils.py]
```

**目录来源**
- [vibe_surf/backend/](file://vibe_surf/backend/)

## 核心组件

后端核心组件包括FastAPI应用、共享状态管理、数据库管理器和各种工具。通过shared_state.py实现全局状态共享，避免循环导入问题。main.py负责应用初始化和生命周期管理。

**核心组件来源**
- [main.py](file://vibe_surf/backend/main.py#L1-L794)
- [shared_state.py](file://vibe_surf/backend/shared_state.py#L1-L800)

## API端点组织

后端API端点按功能组织，每个功能模块有独立的路由文件。所有路由通过main.py统一注册，前缀为/api。

```mermaid
graph TD
api[API端点]
api --> tasks[tasks]
api --> files[files]
api --> activity[activity]
api --> config[config]
api --> browser[browser]
api --> voices[voices]
api --> agent[agent]
api --> composio[composio]
api --> schedule[schedule]
api --> vibesurf[vibesurf]
tasks --> submit[POST /submit]
tasks --> status[GET /status]
tasks --> pause[POST /pause]
tasks --> resume[POST /resume]
tasks --> stop[POST /stop]
browser --> active_tab[GET /active-tab]
browser --> all_tabs[GET /all-tabs]
composio --> status[GET /status]
composio --> verify-key[POST /verify-key]
composio --> toolkits[GET /toolkits]
composio --> toggle[POST /toolkit/{slug}/toggle]
```

**API端点来源**
- [main.py](file://vibe_surf/backend/main.py#L38-L47)
- [task.py](file://vibe_surf/backend/api/task.py)
- [browser.py](file://vibe_surf/backend/api/browser.py)
- [composio.py](file://vibe_surf/backend/api/composio.py)

## 业务逻辑层实现

业务逻辑主要在API路由处理函数中实现，通过依赖注入获取数据库会话。业务逻辑包括任务管理、浏览器操作、Composio集成等。

```mermaid
flowchart TD
A[API请求] --> B{验证输入}
B --> C[获取数据库会话]
C --> D[执行业务逻辑]
D --> E[提交事务]
E --> F[返回响应]
D --> G[异常处理]
G --> H[回滚事务]
H --> I[返回错误]
```

**业务逻辑来源**
- [task.py](file://vibe_surf/backend/api/task.py)
- [composio.py](file://vibe_surf/backend/api/composio.py)
- [browser.py](file://vibe_surf/backend/api/browser.py)

## 数据库访问模式

后端使用SQLAlchemy异步API进行数据库操作，采用Repository模式封装数据访问逻辑。数据库管理器负责连接池和会话管理。

```mermaid
classDiagram
class DatabaseManager {
+engine : AsyncEngine
+async_session_factory : sessionmaker
+get_session() AsyncGenerator[AsyncSession, None]
+create_tables(use_migrations : bool)
+drop_tables()
+close()
}
class DBMigrationManager {
+db_path : str
+migrations_dir : Path
+get_db_version() int
+set_db_version(version : int)
+get_migration_files() List[Tuple[int, str]]
+apply_migrations(target_version : Optional[int])
}
DatabaseManager --> DBMigrationManager : "使用"
DatabaseManager ..> AsyncSession : "创建"
```

**数据库访问来源**
- [manager.py](file://vibe_surf/backend/database/manager.py)
- [queries.py](file://vibe_surf/backend/database/queries.py)

## 中间件配置

后端配置了多种中间件，包括CORS、内容大小限制、JavaScript MIME类型处理等。这些中间件在应用启动时注册。

```mermaid
sequenceDiagram
participant Client
participant Middleware
participant API
Client->>Middleware : HTTP请求
Middleware->>Middleware : CORS检查
Middleware->>Middleware : 内容大小检查
Middleware->>Middleware : JavaScript MIME类型处理
Middleware->>API : 处理请求
API->>Middleware : 生成响应
Middleware->>Client : 返回响应
```

**中间件来源**
- [main.py](file://vibe_surf/backend/main.py#L562-L576)

## 代理系统协调

后端通过VibeSurfAgent协调代理系统，处理任务的执行、暂停、恢复和停止。代理状态通过共享状态管理。

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Running : submit_task
Running --> Paused : pause_task
Paused --> Running : resume_task
Running --> Stopped : stop_task
Paused --> Stopped : stop_task
Stopped --> Idle : clear_active_task
```

**代理系统来源**
- [task.py](file://vibe_surf/backend/api/task.py)
- [shared_state.py](file://vibe_surf/backend/shared_state.py)

## 浏览器管理

后端通过BrowserManager管理浏览器实例，提供获取活动标签和所有标签的API端点。浏览器管理器确保浏览器连接的稳定性。

```mermaid
classDiagram
class BrowserManager {
+main_browser_session : AgentBrowserSession
+get_activate_tab() Dict
+get_all_tabs() List[Dict]
+check_browser_connected() bool
+close()
}
class AgentBrowserSession {
+browser_profile : AgentBrowserProfile
+start()
+kill()
}
BrowserManager --> AgentBrowserSession : "包含"
```

**浏览器管理来源**
- [browser.py](file://vibe_surf/backend/api/browser.py)
- [shared_state.py](file://vibe_surf/backend/shared_state.py)

## LLM调用机制

后端通过LLM配置文件和工厂模式管理不同LLM提供商的调用。支持多种LLM提供商，包括OpenAI、Anthropic、Google等。

```mermaid
classDiagram
class LLMProfileQueries {
+create_profile()
+get_profile()
+list_profiles()
+update_profile()
+delete_profile()
}
class LLMFactory {
+create_llm_from_profile()
+validate_llm_configuration()
+get_llm_creation_parameters()
}
class LLMConfig {
+get_supported_providers()
+get_provider_models()
+get_provider_metadata()
+is_provider_supported()
}
LLMProfileQueries --> LLMFactory : "使用"
LLMFactory --> LLMConfig : "使用"
```

**LLM调用来源**
- [llm_factory.py](file://vibe_surf/backend/utils/llm_factory.py)
- [llm_config.py](file://vibe_surf/backend/llm_config.py)
- [queries.py](file://vibe_surf/backend/database/queries.py)

## 模块化设计

后端采用清晰的模块化设计，各目录职责分明。api目录处理HTTP请求，database目录管理数据持久化，utils目录提供通用工具。

```mermaid
graph TD
api[api模块] --> models[数据模型]
api --> routers[路由]
database[database模块] --> models[数据模型]
database --> manager[管理器]
database --> queries[查询]
utils[utils模块] --> llm_factory[LLM工厂]
utils --> encryption[加密]
utils --> utils[工具函数]
```

**模块化设计来源**
- [vibe_surf/backend/](file://vibe_surf/backend/)
- [api/](file://vibe_surf/backend/api/)
- [database/](file://vibe_surf/backend/database/)
- [utils/](file://vibe_surf/backend/utils/)

## 并发请求处理

后端使用FastAPI的异步特性处理并发请求。通过BackgroundTasks处理耗时操作，避免阻塞主线程。

```mermaid
flowchart TD
A[客户端请求] --> B{是耗时操作?}
B --> |是| C[添加到BackgroundTasks]
B --> |否| D[直接处理]
C --> E[返回快速响应]
D --> F[返回响应]
E --> G[后台执行任务]
G --> H[更新任务状态]
```

**并发处理来源**
- [main.py](file://vibe_surf/backend/main.py)
- [task.py](file://vibe_surf/backend/api/task.py)

## 数据库会话管理

后端使用依赖注入管理数据库会话，确保每个请求都有独立的会话。会话在请求结束时自动提交或回滚。

```mermaid
sequenceDiagram
participant Request
participant Dependency
participant Session
participant Database
Request->>Dependency : 请求数据库会话
Dependency->>Session : 创建新会话
Session->>Database : 连接数据库
Database-->>Session : 连接成功
Session-->>Dependency : 返回会话
Dependency-->>Request : 提供会话
Request->>Database : 执行操作
alt 成功
Database-->>Request : 返回结果
Request->>Session : 提交事务
else 失败
Request->>Session : 回滚事务
end
Session->>Database : 关闭连接
```

**数据库会话来源**
- [manager.py](file://vibe_surf/backend/database/manager.py#L229-L240)
- [main.py](file://vibe_surf/backend/main.py#L277)

## 安全认证机制

后端通过环境变量和加密存储管理API密钥。使用MAC地址派生密钥对敏感数据进行加密。

```mermaid
classDiagram
class Encryption {
+derive_key(machine_id : str) bytes
+get_encryption_key() bytes
+encrypt_api_key(api_key : str) str
+decrypt_api_key(encrypted_api_key : str) str
+is_encrypted(value : str) bool
}
class CredentialQueries {
+get_credential(db, key_name) str
+store_credential(db, key_name, value, description) bool
}
Encryption --> CredentialQueries : "保护"
```

**安全认证来源**
- [encryption.py](file://vibe_surf/backend/utils/encryption.py)
- [queries.py](file://vibe_surf/backend/database/queries.py)

## 性能优化策略

后端采用多种性能优化策略，包括连接池、异步I/O、缓存等。数据库操作使用异步API，避免阻塞。

```mermaid
graph TD
A[性能优化] --> B[连接池]
A --> C[异步I/O]
A --> D[缓存]
A --> E[批量操作]
A --> F[索引优化]
B --> G[数据库连接池]
B --> H[HTTP连接池]
C --> I[异步数据库操作]
C --> J[异步HTTP请求]
D --> K[LLM客户端缓存]
D --> L[组件类型缓存]
E --> M[批量数据库操作]
F --> N[数据库索引]
```

**性能优化来源**
- [manager.py](file://vibe_surf/backend/database/manager.py)
- [main.py](file://vibe_surf/backend/main.py)

## 错误处理策略

后端采用分层错误处理策略，包括输入验证、异常捕获、日志记录等。确保系统稳定性和可维护性。

```mermaid
flowchart TD
A[API请求] --> B[输入验证]
B --> C{验证通过?}
C --> |是| D[业务逻辑]
C --> |否| E[返回422错误]
D --> F{发生异常?}
F --> |否| G[返回成功]
F --> |是| H[日志记录]
H --> I[返回500错误]
```

**错误处理来源**
- [main.py](file://vibe_surf/backend/main.py#L696-L724)
- [task.py](file://vibe_surf/backend/api/task.py)
- [composio.py](file://vibe_surf/backend/api/composio.py)